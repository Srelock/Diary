<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Building Management Diary</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .nav-tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 1.1em;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .nav-tab:hover {
            background: #e9ecef;
            color: #495057;
        }

        .nav-tab.active {
            color: #007bff;
            border-bottom-color: #007bff;
            background: white;
        }

        .tab-content {
            display: none;
            padding: 30px;
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-sm {
            padding: 8px 15px;
            font-size: 0.9em;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }

        .table td {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-open {
            background: #fff3cd;
            color: #856404;
        }

        .status-in-progress {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-closed {
            background: #d4edda;
            color: #155724;
        }

        .status-working {
            background: #d4edda;
            color: #155724;
        }

        .status-off {
            background: #f8d7da;
            color: #721c24;
        }

        .status-holiday {
            background: #fff3cd;
            color: #856404;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }
        
        .card-spaced {
            margin-bottom: 20px;
        }

        .card h3 {
            margin-bottom: 15px;
            color: #495057;
            font-size: 1.2em;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid transparent;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }

        .form-text {
            display: block;
            margin-top: 5px;
            font-size: 0.875em;
            color: #6c757d;
        }

        .form-group label input[type="checkbox"] {
            margin-right: 8px;
        }

        .incident-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .incident-table th {
            background: #e0f2f7;
            padding: 20px 15px;
            text-align: left;
            font-weight: 800;
            color: #000;
            border-bottom: 3px solid #dee2e6;
            font-size: 1.2em;
            letter-spacing: 0.5px;
        }

        .incident-table th:nth-child(1),
        .incident-table th:nth-child(2),
        .incident-table th:nth-child(3) {
            width: 80px;
        }

        .incident-table th:nth-child(4) {
            width: auto;
        }

        .incident-table td {
            padding: 12px 10px;
            border: 2px solid #dee2e6;
            vertical-align: top;
            background: white;
        }

        .incident-table td:nth-child(1),
        .incident-table td:nth-child(2),
        .incident-table td:nth-child(3) {
            width: 80px;
            text-align: center;
        }

        .incident-table tr:hover {
            background: #f8f9fa;
        }

        .schedule-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .shift-box {
            background: #e0f2f7;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px 15px;
            text-align: center;
        }

        .shift-title {
            display: none; /* Hidden per user request */
            font-weight: bold;
            font-size: 14px;
            color: #000;
            margin-bottom: 10px;
            background: #cce7f0;
            padding: 8px;
            border-radius: 4px;
        }

        .staff-member {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #b8d4e0;
        }

        .staff-member:last-child {
            border-bottom: none;
        }

        .staff-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .staff-status {
            font-size: 13px;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .status-working {
            background: #d4edda;
            color: #155724;
        }

        .status-off {
            background: #f8d7da;
            color: #721c24;
        }

        .status-holiday {
            background: #fff3cd;
            color: #856404;
        }

        .status-sick {
            background: #e2e3e5;
            color: #383d41;
        }

        .incident-table input {
            width: 100%;
            border: 2px solid #007bff;
            border-radius: 4px;
            padding: 8px;
            background: #fff;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .incident-table input:focus {
            border-color: #0056b3;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
            outline: none;
        }

        .incident-table input::placeholder {
            color: #6c757d;
            font-style: italic;
        }

        .temperature-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }

        .temperature-value {
            font-size: 3em;
            font-weight: bold;
            margin: 10px 0;
        }

        .temperature-time {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .rota-legend {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }
        
        .legend-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #dee2e6;
        }
        
        .legend-section h4 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1em;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
        }
        
        .legend-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            position: relative;
            padding: 5px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .legend-item:hover {
            background: #f0f0f0;
        }
        
        .legend-item-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .legend-item-actions {
            display: none;
            gap: 5px;
        }
        
        .legend-item:hover .legend-item-actions {
            display: flex;
        }
        
        .staff-edit-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px;
            background: #fff;
            border: 2px solid #007bff;
            border-radius: 5px;
            margin: 5px 0;
        }
        
        .staff-edit-form input, .staff-edit-form select {
            padding: 5px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        
        .staff-edit-form-buttons {
            display: flex;
            gap: 5px;
        }
        
        .legend-color {
            width: 30px;
            height: 30px;
            border-radius: 5px;
            border: 2px solid #333;
        }
        
        .legend-color-red {
            background-color: #ff6b6b;
        }
        
        .legend-color-yellow {
            background-color: #ffd93d;
        }
        
        .legend-color-green {
            background-color: #6bcf7f;
        }
        
        .legend-color-blue {
            background-color: #4d96ff;
        }
        
        /* Night Shift Legend Colors */
        .legend-color-purple {
            background-color: #9b59b6;
        }
        
        .legend-color-darkred {
            background-color: #8b0000;
        }
        
        .legend-color-darkgreen {
            background-color: #2d5016;
        }
        
        .legend-color-brownishyellow {
            background-color: #c9a227;
        }
        
        .rota-subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
        }
        
        .rota-calendar {
            max-height: 700px;
            overflow-y: auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .month-section {
            margin-bottom: 30px;
        }
        
        .month-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 15px 20px;
            font-size: 1.3em;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            border-radius: 10px 10px 0 0;
        }
        
        .rota-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .rota-table thead th {
            background: #e9ecef;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #dee2e6;
            position: sticky;
            top: 53px;
            z-index: 9;
        }
        
        .rota-table td {
            padding: 15px;
            border: 1px solid #dee2e6;
            text-align: center;
            vertical-align: middle;
        }
        
        .rota-date-cell {
            font-weight: 600;
            min-width: 120px;
        }
        
        .rota-day-cell {
            min-width: 100px;
            color: #666;
        }
        
        .rota-week-cell {
            font-size: 0.9em;
            color: #666;
        }
        
        .rota-staff-cell {
            min-width: 250px;
            font-weight: 500;
        }
        
        .staff-shift-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 5px;
        }
        
        .shift-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px 10px;
            border-radius: 4px;
        }
        
        .shift-row .staff-name-text {
            flex: 1;
        }
        
        .shift-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
            background: #6c757d;
            color: white;
            margin-left: 8px;
            white-space: nowrap;
        }
        
        .week-shifts-info {
            font-size: 0.85em;
            color: #666;
            font-weight: 600;
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px solid rgba(255,255,255,0.3);
        }
        
        .color-red {
            background-color: #ff6b6b;
            color: white;
        }
        
        .color-yellow {
            background-color: #ffd93d;
            color: #333;
        }
        
        .color-green {
            background-color: #6bcf7f;
            color: white;
        }
        
        .color-blue {
            background-color: #4d96ff;
            color: white;
        }
        
        /* Night Shift Colors */
        .color-purple {
            background-color: #9b59b6;
            color: white;
        }
        
        .color-darkred {
            background-color: #8b0000;
            color: white;
        }
        
        .color-darkgreen {
            background-color: #2d5016;
            color: white;
        }
        
        .color-brownishyellow {
            background-color: #c9a227;
            color: #333;
        }
        
        .today-row {
            background: #fff3cd !important;
            border: 3px solid #ffc107 !important;
            box-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
        }
        
        .today-row td {
            font-weight: 700 !important;
            border-color: #ffc107 !important;
        }
        
        .today-indicator {
            display: inline-block;
            background: #ffc107;
            color: #000;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 700;
            margin-left: 10px;
        }

        /* Faults Tab Redesign */
        .faults-header {
            text-align: center;
            margin-bottom: 35px;
        }
        
        .faults-header h2 {
            font-size: 2em;
            color: #2c3e50;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .faults-subtitle {
            color: #6c757d;
            font-size: 1.05em;
            font-weight: 400;
        }
        
        .faults-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            align-items: start;
        }
        
        .fault-report-card,
        .fault-log-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .fault-report-card:hover,
        .fault-log-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }
        
        .fault-card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .fault-card-header h3 {
            margin: 0;
            font-size: 1.3em;
            font-weight: 600;
            color: white;
        }
        
        .fault-stats {
            display: flex;
            gap: 15px;
            font-size: 0.9em;
        }
        
        .fault-stat-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }
        
        .fault-form {
            padding: 30px;
        }
        
        .fault-input {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 14px 16px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        .fault-input:focus {
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            outline: none;
        }
        
        .fault-input::placeholder {
            color: #adb5bd;
            font-style: italic;
        }
        
        .fault-textarea {
            resize: vertical;
            min-height: 120px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .btn-fault-submit {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-fault-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn-fault-submit:active {
            transform: translateY(0);
        }
        
        .btn-icon {
            font-size: 1.2em;
        }
        
        .fault-list {
            padding: 25px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .fault-list::-webkit-scrollbar {
            width: 8px;
        }
        
        .fault-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .fault-list::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }
        
        .fault-list::-webkit-scrollbar-thumb:hover {
            background: #5568d3;
        }
        
        .fault-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .fault-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 5px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }
        
        .fault-item:hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
            transform: translateX(5px);
        }
        
        .fault-item:hover::before {
            width: 8px;
        }
        
        .fault-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }
        
        .fault-type-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #667eea;
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }
        
        .fault-type-badge.intercom {
            background: #764ba2;
        }
        
        .fault-timestamp {
            font-size: 0.85em;
            color: #6c757d;
            font-weight: 500;
        }
        
        .fault-location {
            font-size: 1.05em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .fault-description {
            color: #495057;
            line-height: 1.6;
            margin-bottom: 10px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            border-left: 3px solid #e9ecef;
        }
        
        .fault-contact,
        .fault-notes {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 8px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .fault-contact {
            border-left: 3px solid #28a745;
        }
        
        .fault-notes {
            border-left: 3px solid #17a2b8;
        }
        
        .fault-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .fault-status-badge {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .fault-status-badge.status-open {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            color: #856404;
        }
        
        .fault-status-badge.status-in-progress {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
        }
        
        .fault-status-badge.status-closed {
            background: linear-gradient(135deg, #55efc4 0%, #00b894 100%);
            color: white;
        }
        
        .btn-fault-action {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-fault-progress {
            background: #74b9ff;
            color: white;
        }
        
        .btn-fault-progress:hover {
            background: #0984e3;
            transform: translateY(-2px);
        }
        
        .btn-fault-close {
            background: #55efc4;
            color: white;
        }
        
        .btn-fault-close:hover {
            background: #00b894;
            transform: translateY(-2px);
        }
        
        .btn-fault-reopen {
            background: #fdcb6e;
            color: #2d3436;
        }
        
        .btn-fault-reopen:hover {
            background: #f39c12;
            transform: translateY(-2px);
        }
        
        .fault-empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .fault-empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .fault-empty-state h4 {
            font-size: 1.3em;
            margin-bottom: 10px;
            color: #495057;
        }
        
        .fault-empty-state p {
            font-size: 1em;
            color: #6c757d;
        }
        
        .fault-search-bar {
            padding: 20px 25px;
            background: #ffffff;
            border-bottom: 1px solid #e9ecef;
        }
        
        .fault-search-input {
            width: 100%;
            padding: 12px 15px;
            font-size: 1em;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .fault-search-input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .fault-filter-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .fault-filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .fault-filter-btn {
            padding: 10px 20px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: white;
            color: #6c757d;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .fault-filter-btn:hover {
            border-color: #667eea;
            color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.2);
        }
        
        .fault-filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-print-faults {
            padding: 10px 24px;
            border: 2px solid #28a745;
            border-radius: 8px;
            background: white;
            color: #28a745;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-print-faults:hover {
            background: #28a745;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        /* Hide print table on screen, only show when printing */
        .print-table-container {
            display: none;
        }
        
        /* Print Styles */
        @media print {
            body {
                background: white;
                padding: 20px;
                color: black;
            }
            
            /* Hide everything on screen during print */
            .container {
                display: none !important;
            }
            
            /* Show only the print container */
            #faultPrintContainer {
                display: block !important;
            }
            
            .header,
            .nav-tabs,
            .faults-header,
            .fault-report-card,
            .fault-filter-bar,
            .btn-fault-action,
            .fault-card-header,
            .fault-type-badge,
            .fault-timestamp,
            .fault-status-badge,
            .fault-actions {
                display: none !important;
            }
            
            .faults-grid {
                grid-template-columns: 1fr;
            }
            
            .fault-log-card {
                box-shadow: none;
                border-radius: 0;
                background: white;
                max-height: none !important;
                overflow: visible !important;
            }
            
            .fault-list {
                max-height: none !important;
                padding: 0;
                background: white;
                overflow: visible !important;
                height: auto !important;
            }
            
            /* Hide card-based layout when printing */
            .fault-list .fault-item {
                display: none !important;
            }
            
            .fault-search-bar,
            .fault-empty-state {
                display: none !important;
            }
            
            /* Show table layout only when printing */
            .print-table-container {
                display: block !important;
            }
            
            .fault-print-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
                font-size: 10pt;
                page-break-inside: auto;
                display: table !important;
                max-height: none !important;
                overflow: visible !important;
            }
            
            .fault-print-table thead {
                background: #2c3e50;
                color: white;
                display: table-header-group !important;
            }
            
            .fault-print-table tbody {
                display: table-row-group !important;
            }
            
            .fault-print-table th {
                border: 1px solid #000;
                padding: 8px 6px;
                text-align: left;
                font-weight: bold;
                font-size: 9pt;
                display: table-cell !important;
            }
            
            .fault-print-table td {
                border: 1px solid #666;
                padding: 6px 5px;
                text-align: left;
                font-size: 9pt;
                vertical-align: top;
                display: table-cell !important;
            }
            
            .fault-print-table tr {
                page-break-inside: avoid;
                display: table-row !important;
            }
            
            .fault-print-table tbody tr:nth-child(even) {
                background-color: #f9f9f9;
            }
            
            .print-title {
                font-size: 18pt;
                font-weight: bold;
                text-align: center;
                margin-bottom: 10px;
            }
            
            .print-date {
                text-align: center;
                font-size: 11pt;
                margin-bottom: 15px;
                color: #666;
            }
            
            .fault-item {
                page-break-inside: avoid;
                break-inside: avoid;
                margin-bottom: 15px;
                padding: 0;
                background: white;
                border: none;
                border-bottom: 1px solid #333;
                padding-bottom: 12px;
            }
            
            .fault-item::before {
                display: none;
            }
            
            .fault-item-header {
                display: none;
            }
            
            .fault-location {
                font-size: 12pt;
                font-weight: bold;
                color: black;
                margin-bottom: 5px;
            }
            
            .fault-location::before {
                content: "Location: ";
                font-weight: normal;
            }
            
            .fault-description {
                font-size: 11pt;
                color: black;
                line-height: 1.4;
                margin-bottom: 0;
                padding: 0;
                background: white;
                border: none;
            }
            
            .fault-description::before {
                content: "Fault: ";
                font-weight: bold;
            }
            
            .print-title {
                display: block !important;
                text-align: center;
                font-size: 18pt;
                font-weight: bold;
                margin-bottom: 8px;
                color: black;
                text-transform: uppercase;
            }
            
            .print-date {
                display: block !important;
                text-align: center;
                font-size: 11pt;
                color: black;
                margin-bottom: 25px;
                padding-bottom: 10px;
                border-bottom: 2px solid black;
            }
            
            .fault-empty-state {
                text-align: center;
                padding: 40px;
            }
            
            .fault-empty-state-icon {
                display: none;
            }
            
            .fault-empty-state h4,
            .fault-empty-state p {
                color: black;
            }
            
            .screen-only {
                display: none !important;
            }
        }
        
        .print-title,
        .print-date {
            display: none;
        }

        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
            }
            
            .nav-tab {
                border-bottom: 1px solid #dee2e6;
                border-right: none;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .rota-legend {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .schedule-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .rota-table {
                font-size: 0.85em;
            }
            
            .faults-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .fault-report-card,
            .fault-log-card {
                border-radius: 12px;
            }
            
            .fault-form {
                padding: 20px;
            }
            
            .fault-form > div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
            }
            
            .fault-list {
                padding: 15px;
                max-height: 400px;
            }
            
            .fault-item {
                padding: 15px;
            }
            
            .fault-item-header {
                flex-direction: column;
                gap: 10px;
            }
            
            .fault-actions {
                flex-direction: column;
                width: 100%;
            }
            
            .btn-fault-action {
                width: 100%;
            }
            
            .fault-stats {
                flex-direction: column;
                gap: 8px;
            }
            
            .fault-search-bar {
                padding: 15px;
            }
            
            .fault-search-input {
                font-size: 0.95em;
            }
            
            .fault-filter-bar {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            
            .fault-filter-buttons {
                width: 100%;
                justify-content: center;
            }
            
            .fault-filter-btn {
                flex: 1;
                min-width: 100px;
                padding: 8px 12px;
                font-size: 0.85em;
            }
            
            .btn-print-faults {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* Shake animation for wrong PIN */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Building Management Diary</h1>
            <p>Daily Operations, 3-Shift Staff Rota, Faults & Temperature Monitoring</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('daily')">Daily Occurrences</button>
            <button class="nav-tab" onclick="showTab('rota')">Staff Rota</button>
            <button class="nav-tab" onclick="showTab('faults')">CCTV/Intercom Faults</button>
            <button class="nav-tab" onclick="showTab('temperature')">Water Temperature</button>
            <button class="nav-tab" onclick="showTab('settings')">Settings</button>
        </div>

        <!-- Daily Occurrences Tab -->
        <div id="daily" class="tab-content active">
            <h2>Daily Occurrences</h2>
            
            <!-- Staff Schedule for Today -->
            <div class="card card-spaced">
                <h3>Today's Staff Schedule</h3>
                <div id="todaySchedule" class="loading">Loading...</div>
            </div>
            
            <div class="card">
                <h3>Today's Occurrences</h3>
                <div id="dailyList" class="loading">Loading...</div>
            </div>
        </div>

        <!-- Staff Rota Tab -->
        <div id="rota" class="tab-content">
            <h2>Porter Day Off Chart</h2>
            <p class="rota-subtitle">Three-Shift Rotation Schedule (Day, Evening & Night)</p>
            
            <div class="rota-legend">
                <div class="legend-section">
                    <h4>Shift 1 <button class="btn btn-sm btn-primary" onclick="showAddStaffForm(1)" style="padding: 4px 10px; font-size: 0.85em;">+ Add Staff</button></h4>
                    <div id="shift1Legend" class="legend-items">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
                <div class="legend-section">
                    <h4>Shift 2 <button class="btn btn-sm btn-primary" onclick="showAddStaffForm(2)" style="padding: 4px 10px; font-size: 0.85em;">+ Add Staff</button></h4>
                    <div id="shift2Legend" class="legend-items">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
                <div class="legend-section">
                    <h4>Night Shift <button class="btn btn-sm btn-primary" onclick="showAddStaffForm(3)" style="padding: 4px 10px; font-size: 0.85em;">+ Add Staff</button></h4>
                    <div id="shift3Legend" class="legend-items">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>
            
            <!-- Rota Navigation -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <button class="btn btn-primary" onclick="navigateRotaPrevious()" style="padding: 10px 20px;">
                    ‚óÑ Previous 3 Months
                </button>
                <div style="text-align: center;">
                    <div id="rotaDateRange" style="font-weight: 600; font-size: 1.1em; color: #333;">Loading...</div>
                    <button class="btn btn-secondary" onclick="navigateRotaToday()" style="margin-top: 8px; padding: 6px 15px; font-size: 0.9em;">
                        Jump to Today
                    </button>
                </div>
                <button class="btn btn-primary" onclick="navigateRotaNext()" style="padding: 10px 20px;">
                    Next 3 Months ‚ñ∫
                </button>
            </div>
            
            <div id="rotaCalendar" class="loading">Loading rota...</div>
            
            <!-- Holiday & Sick Leave Management -->
            <div class="card card-spaced" style="margin-top: 30px;">
                <h3>Holiday & Sick Leave Management</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="card" style="padding: 15px; box-shadow: none; border: 2px solid #ffc107;">
                        <h4 style="color: #856404; margin-bottom: 15px;">üìÖ Add Holiday</h4>
                        <form id="holidayForm">
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label for="holiday_staff">Staff Member:</label>
                                <select id="holiday_staff" class="form-control" required></select>
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label for="holiday_date_from">From Date:</label>
                                <input type="date" id="holiday_date_from" class="form-control" required>
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label for="holiday_date_to">To Date:</label>
                                <input type="date" id="holiday_date_to" class="form-control" required>
                                <small class="form-text">For single day, use same date for both</small>
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label for="holiday_notes">Notes (optional):</label>
                                <input type="text" id="holiday_notes" class="form-control" placeholder="Reason for holiday...">
                            </div>
                            <button type="submit" class="btn btn-warning">Add Holiday</button>
                        </form>
                    </div>
                    
                    <div class="card" style="padding: 15px; box-shadow: none; border: 2px solid #6c757d;">
                        <h4 style="color: #383d41; margin-bottom: 15px;">üè• Add Sick Leave</h4>
                        <form id="sickForm">
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label for="sick_staff">Staff Member:</label>
                                <select id="sick_staff" class="form-control" required></select>
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label for="sick_date_from">From Date:</label>
                                <input type="date" id="sick_date_from" class="form-control" required>
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label for="sick_date_to">To Date:</label>
                                <input type="date" id="sick_date_to" class="form-control" required>
                                <small class="form-text">For single day, use same date for both</small>
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label for="sick_notes">Notes (optional):</label>
                                <input type="text" id="sick_notes" class="form-control" placeholder="Illness details...">
                            </div>
                            <button type="submit" class="btn" style="background: #6c757d; color: white;">Add Sick Leave</button>
                        </form>
                    </div>
                </div>
                
                <!-- Current Leave List -->
                <h4 style="margin-top: 20px; margin-bottom: 15px;">Current & Upcoming Leave</h4>
                <div id="leaveList" class="loading">Loading...</div>
            </div>
        </div>

        <!-- CCTV/Intercom Faults Tab -->
        <div id="faults" class="tab-content">
            <div class="faults-header">
                <h2>üîß CCTV & Intercom Faults</h2>
                <p class="faults-subtitle">Report and track system malfunctions</p>
            </div>
            
            <div class="faults-grid">
                <div class="fault-report-card">
                    <div class="fault-card-header">
                        <h3>üìù Report New Fault</h3>
                    </div>
                    <form id="faultForm" class="fault-form">
                        <div class="form-group">
                            <label for="fault_type">Fault Type</label>
                            <select id="fault_type" class="form-control fault-input" required>
                                <option value="">Select fault type...</option>
                                <option value="CCTV">üìπ CCTV</option>
                                <option value="Intercom">üìû Intercom</option>
                            </select>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label for="flat_number">Flat Number</label>
                                <input type="text" id="flat_number" class="form-control fault-input" placeholder="e.g., 568, 478A" required>
                            </div>
                            <div class="form-group">
                                <label for="block_number">Block</label>
                                <input type="text" id="block_number" class="form-control fault-input" placeholder="e.g., 8">
                            </div>
                            <div class="form-group">
                                <label for="floor_number">Floor/Level</label>
                                <input type="text" id="floor_number" class="form-control fault-input" placeholder="e.g., 8">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="fault_description_type">Description of Fault</label>
                            <select id="fault_description_type" class="form-control fault-input" required>
                                <option value="">Select fault description...</option>
                                <option value="NOT WORKING">NOT WORKING</option>
                                <option value="INSTALLATION">INSTALLATION</option>
                                <option value="REPAIR NEEDED">REPAIR NEEDED</option>
                                <option value="REPLACEMENT">REPLACEMENT</option>
                                <option value="NO AUDIO">NO AUDIO</option>
                                <option value="NO VIDEO">NO VIDEO</option>
                                <option value="POOR QUALITY">POOR QUALITY</option>
                                <option value="OTHER">OTHER</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="contact_details">Contact Number/Details</label>
                            <input type="text" id="contact_details" class="form-control fault-input" placeholder="Contact number or additional details">
                        </div>
                        
                        <div class="form-group">
                            <label for="additional_notes">Additional Notes (Optional)</label>
                            <textarea id="additional_notes" class="form-control fault-input fault-textarea" rows="3" placeholder="Any additional information..."></textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-fault-submit">
                            <span class="btn-icon">‚ö°</span> Report Fault
                        </button>
                    </form>
                </div>
                
                <div class="fault-log-card">
                    <div class="fault-card-header">
                        <h3>üìã Fault Log</h3>
                        <div class="fault-stats" id="faultStats"></div>
                    </div>
                    <div class="fault-search-bar">
                        <input type="text" id="faultSearch" class="form-control fault-search-input" placeholder="üîç Search faults by ID, location, or description...">
                    </div>
                    <div class="fault-filter-bar">
                        <div class="fault-filter-buttons">
                            <button class="fault-filter-btn active" data-filter="all" onclick="filterFaults('all')">
                                üìä All Faults
                            </button>
                            <button class="fault-filter-btn" data-filter="CCTV" onclick="filterFaults('CCTV')">
                                üìπ CCTV Only
                            </button>
                            <button class="fault-filter-btn" data-filter="Intercom" onclick="filterFaults('Intercom')">
                                üìû Intercom Only
                            </button>
                        </div>
                        <button class="btn-print-faults" onclick="printFaults()">
                            üñ®Ô∏è Print
                        </button>
                    </div>
                    <div id="faultList" class="fault-list loading">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Water Temperature Tab -->
        <div id="temperature" class="tab-content">
            <h2>Water Temperature Monitoring</h2>
            <div class="grid">
                <div class="card">
                    <h3>Record Temperature</h3>
                    <form id="tempForm">
                        <div class="form-group">
                            <label for="temp_time">Time:</label>
                            <select id="temp_time" class="form-control" required>
                                <option value="">Select Time</option>
                                <option value="00:00">00:00 (Midnight)</option>
                                <option value="01:00">01:00</option>
                                <option value="02:00">02:00</option>
                                <option value="03:00">03:00</option>
                                <option value="04:00">04:00</option>
                                <option value="05:00">05:00</option>
                                <option value="06:00">06:00</option>
                                <option value="07:00">07:00</option>
                                <option value="08:00">08:00</option>
                                <option value="09:00">09:00</option>
                                <option value="10:00">10:00</option>
                                <option value="11:00">11:00</option>
                                <option value="12:00">12:00 (Noon)</option>
                                <option value="13:00">13:00</option>
                                <option value="14:00">14:00</option>
                                <option value="15:00">15:00</option>
                                <option value="16:00">16:00</option>
                                <option value="17:00">17:00</option>
                                <option value="18:00">18:00</option>
                                <option value="19:00">19:00</option>
                                <option value="20:00">20:00</option>
                                <option value="21:00">21:00</option>
                                <option value="22:00">22:00</option>
                                <option value="23:00">23:00</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="temp_input">Temperature (¬∞C):</label>
                            <input type="number" id="temp_input" class="form-control" step="0.1" placeholder="Enter temperature" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Record Temperature</button>
                    </form>
                </div>
                <div class="card">
                    <h3>Latest Reading</h3>
                    <div id="currentTemp" class="temperature-display">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3>üìä Temperature History & Analytics</h3>
                
                <!-- Quick Filter Buttons -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="loadTempPeriod('today')" id="btnToday">Today</button>
                    <button class="btn btn-secondary" onclick="loadTempPeriod('week')" id="btnWeek">This Week</button>
                    <button class="btn btn-secondary" onclick="loadTempPeriod('lastweek')" id="btnLastWeek">Last Week</button>
                    <button class="btn btn-secondary" onclick="loadTempPeriod('month')" id="btnMonth">This Month</button>
                    <button class="btn btn-secondary" onclick="loadTempPeriod('custom')" id="btnCustom">Custom Range</button>
                </div>
                
                <!-- Custom Date Range (hidden by default) -->
                <div id="customDateRange" style="display: none; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="temp_date_from">From Date:</label>
                            <input type="date" id="temp_date_from" class="form-control" style="width: auto;">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="temp_date_to">To Date:</label>
                            <input type="date" id="temp_date_to" class="form-control" style="width: auto;">
                        </div>
                        <button class="btn btn-primary" onclick="loadCustomTempRange()">Load</button>
                    </div>
                </div>
                
                <!-- Statistics Summary -->
                <div id="tempStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <!-- Stats will be inserted here -->
                </div>
                
                <!-- Temperature History Table -->
                <div style="max-height: 500px; overflow-y: auto; overflow-x: hidden;">
                    <div id="tempHistory" class="loading">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <h2>üîê Email & Schedule Settings</h2>
            
            <!-- PIN Authentication Overlay -->
            <div id="settingsPinOverlay" class="card" style="max-width: 450px; margin: 50px auto; padding: 40px; background: white; border: 2px solid #e0e0e0; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div style="text-align: center; margin-bottom: 30px;">
                    <div style="font-size: 4em; margin-bottom: 15px;">üîí</div>
                    <h3 style="color: #333; margin: 0; font-weight: 600;">Settings Access Protected</h3>
                </div>
                <form id="settingsPinForm" onsubmit="verifySettingsPin(event)">
                    <div class="form-group">
                        <label for="settings_pin_code" style="color: #333; font-weight: 600; font-size: 1.1em;">PIN Code:</label>
                        <input type="password" id="settings_pin_code" class="form-control" placeholder="Enter PIN" required maxlength="10" style="font-size: 1.8em; padding: 20px; text-align: center; letter-spacing: 8px; border: 2px solid #ddd; border-radius: 8px;">
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 15px; font-size: 1.1em; margin-top: 10px; background: #007bff; border: none; font-weight: 600;">
                        üîì Unlock Settings
                    </button>
                </form>
                <div id="settingsPinError" style="margin-top: 15px; padding: 12px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px; color: #721c24; display: none; text-align: center; font-weight: 500;">
                </div>
            </div>
            
            <!-- Settings Content (Initially Hidden) -->
            <div id="settingsContent" style="display: none;">
                <div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <strong>üîì Unlocked by:</strong> <span id="settingsUnlockedBy">Unknown</span>
                    <button onclick="lockSettings()" class="btn btn-danger" style="float: right; padding: 5px 15px;">üîí Lock Settings</button>
                </div>
                
                <div class="grid">
                    <div class="card">
                        <h3>Email Schedule Configuration</h3>
                        <form id="settingsForm">
                        <div class="form-group">
                            <label for="email_time">Daily Report Time:</label>
                            <input type="time" id="email_time" class="form-control" required>
                            <small class="form-text">Set the time when daily reports should be sent automatically</small>
                        </div>
                        <div class="form-group">
                            <label for="recipient_email">Recipient Email(s):</label>
                            <input type="text" id="recipient_email" class="form-control" placeholder="email1@example.com, email2@example.com" required>
                            <small class="form-text">Enter one or more email addresses separated by commas (e.g., john@example.com, jane@example.com)</small>
                        </div>
                        
                        <hr style="margin: 20px 0; border-top: 2px solid #ddd;">
                        <h4 style="margin-bottom: 15px; color: #333;">üìß Sender Email Configuration</h4>
                        
                        <div class="form-group">
                            <label for="sender_email">Sender Email Address:</label>
                            <input type="email" id="sender_email" class="form-control" placeholder="your-email@gmail.com" required>
                            <small class="form-text">The email address that will send the daily reports</small>
                        </div>
                        <div class="form-group">
                            <label for="sender_password">Email Password / App Password:</label>
                            <input type="password" id="sender_password" class="form-control" placeholder="Enter app password" required>
                            <small class="form-text">For Gmail, use an App Password (not your regular password). <a href="https://support.google.com/accounts/answer/185833" target="_blank" rel="noopener">Learn how</a></small>
                        </div>
                        <div class="form-group">
                            <label for="smtp_server">SMTP Server:</label>
                            <input type="text" id="smtp_server" class="form-control" value="smtp.gmail.com" required>
                            <small class="form-text">SMTP server address (e.g., smtp.gmail.com for Gmail, smtp.office365.com for Outlook)</small>
                        </div>
                        <div class="form-group">
                            <label for="smtp_port">SMTP Port:</label>
                            <input type="number" id="smtp_port" class="form-control" value="587" required>
                            <small class="form-text">Usually 587 for TLS or 465 for SSL</small>
                        </div>
                        
                        <hr style="margin: 20px 0; border-top: 2px solid #ddd;">
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="email_enabled" checked> Enable automatic email sending
                            </label>
                            <small class="form-text">Uncheck to disable automatic daily reports</small>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Settings</button>
                        <button type="button" class="btn btn-success" onclick="testEmail()">Test Email</button>
                        <button type="button" class="btn btn-warning" onclick="testExport()">Test Export PDF</button>
                        <button type="button" class="btn btn-danger" onclick="testClear()">Test Clear Diary</button>
                    </form>
                </div>
                <div class="card">
                    <h3>Current Settings</h3>
                    <div id="currentSettings" class="loading">Loading...</div>
                </div>
            </div>
            <div class="card">
                <h3>Email History</h3>
                <div id="emailHistory" class="loading" style="max-height: 400px; overflow-y: auto; overflow-x: hidden;">Loading...</div>
                <p style="text-align: center; color: #6c757d; font-size: 0.9em; margin-top: 10px;">
                    <small>Showing recent emails (scroll for more)</small>
                </p>
            </div>
            
            <div class="card" style="margin-top: 20px;">
                <h3>üîê Change Shift Leader PIN</h3>
                <p style="color: #6c757d; margin-bottom: 15px;">For security, shift leaders should change their default PIN (1234) immediately.</p>
                <form id="changePinForm" onsubmit="handleChangePinSubmit(event)">
                    <div class="form-group">
                        <label for="change_pin_name">Your Name:</label>
                        <select id="change_pin_name" class="form-control" required>
                            <option value="">Select your name...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="change_pin_old">Current PIN:</label>
                        <input type="password" id="change_pin_old" class="form-control" placeholder="Enter current PIN" required maxlength="10">
                    </div>
                    <div class="form-group">
                        <label for="change_pin_new">New PIN:</label>
                        <input type="password" id="change_pin_new" class="form-control" placeholder="Enter new PIN (min 4 digits)" required minlength="4" maxlength="10">
                    </div>
                    <div class="form-group">
                        <label for="change_pin_confirm">Confirm New PIN:</label>
                        <input type="password" id="change_pin_confirm" class="form-control" placeholder="Re-enter new PIN" required maxlength="10">
                    </div>
                    <button type="submit" class="btn btn-primary">Change PIN</button>
                </form>
            </div>
            
            <div class="card" style="margin-top: 20px;">
                <h3>üìã Settings Access Logs</h3>
                <p style="color: #6c757d; margin-bottom: 15px;">View recent access attempts and modifications. Log file: <code>logs/settings_access.log</code></p>
                <button onclick="loadSettingsAccessLogs()" class="btn btn-primary" style="margin-bottom: 15px;">üîÑ Refresh Logs</button>
                <div id="settingsAccessLogs" class="loading" style="max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 0.9em;">
                    Loading logs...
                </div>
            </div>
            </div>
            <!-- End Settings Content -->
        </div>
    </div>

    <script>
        // Global variables
        let currentTab = 'daily';
        let allFaults = [];
        let currentFaultFilter = 'all';
        let currentSearchText = '';
        let settingsUnlockedStaff = null; // Track who unlocked settings

        // Settings PIN Authentication
        function verifySettingsPin(event) {
            event.preventDefault();
            
            const pin = document.getElementById('settings_pin_code').value;
            
            fetch('/api/verify-settings-pin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ pin })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Success - unlock settings
                    settingsUnlockedStaff = data.name;
                    document.getElementById('settingsPinOverlay').style.display = 'none';
                    document.getElementById('settingsContent').style.display = 'block';
                    document.getElementById('settingsUnlockedBy').textContent = data.name;
                    
                    // Clear form
                    document.getElementById('settings_pin_code').value = '';
                    
                    showAlert(`Settings unlocked by ${data.name}`, 'success');
                } else {
                    // Failed - show error
                    const errorDiv = document.getElementById('settingsPinError');
                    errorDiv.textContent = '‚ùå ' + (data.error || 'Invalid PIN');
                    errorDiv.style.display = 'block';
                    
                    // Clear PIN field and refocus
                    document.getElementById('settings_pin_code').value = '';
                    document.getElementById('settings_pin_code').focus();
                    
                    // Hide error after 4 seconds
                    setTimeout(() => {
                        errorDiv.style.display = 'none';
                    }, 4000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Error verifying PIN', 'danger');
            });
        }
        
        function lockSettings() {
            // Lock settings
            document.getElementById('settingsPinOverlay').style.display = 'block';
            document.getElementById('settingsContent').style.display = 'none';
            settingsUnlockedStaff = null;
            
            // Clear PIN form
            document.getElementById('settings_pin_code').value = '';
            
            showAlert('Settings locked', 'info');
        }
        
        function loadSettingsAccessLogs() {
            // Load and display settings access logs
            const container = document.getElementById('settingsAccessLogs');
            container.innerHTML = '<p style="text-align: center; padding: 20px;">Loading logs...</p>';
            
            fetch('/api/settings-access-logs')
                .then(response => response.json())
                .then(data => {
                    if (data.logs && data.logs.length > 0) {
                        let html = `<div style="margin-bottom: 10px; color: #666;">
                            <strong>Recent Access Attempts</strong> (showing ${data.logs.length} of ${data.total_count} total)
                        </div>`;
                        
                        data.logs.forEach(log => {
                            // Color code based on success/failure
                            let color = '#28a745'; // green for success
                            let bgColor = '#d4edda';
                            let icon = '‚úÖ';
                            
                            if (log.includes('FAILED') || log.includes('Wrong PIN') || log.includes('Invalid User')) {
                                color = '#dc3545'; // red for failed
                                bgColor = '#f8d7da';
                                icon = '‚ùå';
                            }
                            
                            html += `<div style="padding: 8px; margin-bottom: 5px; background: ${bgColor}; border-left: 3px solid ${color}; border-radius: 3px; color: #333;">
                                ${icon} ${log}
                            </div>`;
                        });
                        
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No access logs yet. Logs are saved to: <strong>logs/settings_access.log</strong></p>';
                    }
                })
                .catch(error => {
                    console.error('Error loading logs:', error);
                    container.innerHTML = '<p style="color: #dc3545; padding: 20px;">Error loading logs. Check console for details.</p>';
                });
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadDailyOccurrences();
            loadTodaySchedule();
            loadStaffMembers();
            loadPorterRota();
            loadCCTVFaults();
            loadWaterTemperature();
            loadScheduleSettings();
            loadEmailHistory();
            loadLeaveData();
            loadSettingsAccessLogs();
            
            // Set up form handlers
            document.getElementById('holidayForm').addEventListener('submit', handleHolidaySubmit);
            document.getElementById('sickForm').addEventListener('submit', handleSickSubmit);
            
            // Set up fault search handler
            const faultSearchInput = document.getElementById('faultSearch');
            if (faultSearchInput) {
                faultSearchInput.addEventListener('input', function(e) {
                    currentSearchText = e.target.value;
                    displayFaults(currentFaultFilter);
                });
            }
        });
        
        // Staff Management Functions
        function loadStaffMembers() {
            fetch('/api/staff-members')
            .then(response => response.json())
            .then(data => {
                displayStaffLegend(data);
                populateStaffDropdowns(data);
            })
            .catch(error => {
                console.error('Error loading staff:', error);
                document.getElementById('shift1Legend').innerHTML = '<p style="color: red;">Error loading staff</p>';
                document.getElementById('shift2Legend').innerHTML = '<p style="color: red;">Error loading staff</p>';
                document.getElementById('shift3Legend').innerHTML = '<p style="color: red;">Error loading staff</p>';
            });
        }
        
        function populateStaffDropdowns(staffList) {
            const holidaySelect = document.getElementById('holiday_staff');
            const sickSelect = document.getElementById('sick_staff');
            
            if (!holidaySelect || !sickSelect) return;
            
            const options = '<option value="">Select Staff Member</option>' + 
                staffList.map(s => {
                    const shiftName = s.shift === 3 ? 'Night Shift' : `Shift ${s.shift}`;
                    return `<option value="${s.name}">${s.name} (${shiftName})</option>`;
                }).join('');
            
            holidaySelect.innerHTML = options;
            sickSelect.innerHTML = options;
        }
        
        function displayStaffLegend(staffList) {
            const shift1Container = document.getElementById('shift1Legend');
            const shift2Container = document.getElementById('shift2Legend');
            const shift3Container = document.getElementById('shift3Legend');
            
            const shift1Staff = staffList.filter(s => s.shift === 1);
            const shift2Staff = staffList.filter(s => s.shift === 2);
            const shift3Staff = staffList.filter(s => s.shift === 3);
            
            shift1Container.innerHTML = '';
            shift2Container.innerHTML = '';
            shift3Container.innerHTML = '';
            
            if (shift1Staff.length === 0) {
                shift1Container.innerHTML = '<p style="color: #666; font-size: 0.9em;">No staff assigned</p>';
            } else {
                shift1Staff.forEach(staff => {
                    shift1Container.appendChild(createStaffLegendItem(staff));
                });
            }
            
            if (shift2Staff.length === 0) {
                shift2Container.innerHTML = '<p style="color: #666; font-size: 0.9em;">No staff assigned</p>';
            } else {
                shift2Staff.forEach(staff => {
                    shift2Container.appendChild(createStaffLegendItem(staff));
                });
            }
            
            if (shift3Staff.length === 0) {
                shift3Container.innerHTML = '<p style="color: #666; font-size: 0.9em;">No staff assigned</p>';
            } else {
                shift3Staff.forEach(staff => {
                    shift3Container.appendChild(createStaffLegendItem(staff));
                });
            }
        }
        
        function createStaffLegendItem(staff) {
            const div = document.createElement('div');
            div.className = 'legend-item';
            div.id = `staff-${staff.id}`;
            div.setAttribute('data-shift', staff.shift);
            div.setAttribute('data-color', staff.color);
            
            div.innerHTML = `
                <div class="legend-item-content">
                    <div class="legend-color legend-color-${staff.color}"></div>
                    <span>${staff.name}</span>
                </div>
                <div class="legend-item-actions">
                    <button class="btn btn-sm btn-warning" onclick="editStaff(${staff.id})" style="padding: 2px 8px; font-size: 0.8em;">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteStaff(${staff.id})" style="padding: 2px 8px; font-size: 0.8em;">Remove</button>
                </div>
            `;
            
            return div;
        }
        
        function showAddStaffForm(shift) {
            // Require PIN authentication first
            requirePinAuth(() => {
                const container = shift === 1 ? document.getElementById('shift1Legend') : 
                                 shift === 2 ? document.getElementById('shift2Legend') : 
                                 document.getElementById('shift3Legend');
                
                // Check if form already exists
                if (container.querySelector('.staff-edit-form')) {
                    return;
                }
                
                const formDiv = document.createElement('div');
                formDiv.className = 'staff-edit-form';
                
                // Different color options for Night Shift
                let colorOptions = '';
                if (shift === 3) {
                    colorOptions = `
                        <option value="">Select Color</option>
                        <option value="purple">Purple</option>
                        <option value="darkred">Dark Red</option>
                        <option value="darkgreen">Dark Green</option>
                        <option value="brownishyellow">Brownish Yellow</option>
                    `;
                } else {
                    colorOptions = `
                        <option value="">Select Color</option>
                        <option value="red">Red</option>
                        <option value="yellow">Yellow</option>
                        <option value="green">Green</option>
                        <option value="blue">Blue</option>
                    `;
                }
                
                formDiv.innerHTML = `
                    <h5 style="margin: 0 0 5px 0;">Add New Staff</h5>
                    <input type="text" id="new-staff-name-${shift}" placeholder="Staff Name" required>
                    <select id="new-staff-color-${shift}" required>
                        ${colorOptions}
                    </select>
                    <div class="staff-edit-form-buttons">
                        <button class="btn btn-sm btn-success" onclick="saveNewStaff(${shift})">Save</button>
                        <button class="btn btn-sm btn-secondary" onclick="cancelAddStaff(${shift})">Cancel</button>
                    </div>
                `;
                
                container.insertBefore(formDiv, container.firstChild);
            });
        }
        
        function saveNewStaff(shift) {
            const name = document.getElementById(`new-staff-name-${shift}`).value.trim();
            const color = document.getElementById(`new-staff-color-${shift}`).value;
            
            if (!name || !color) {
                showAlert('Please fill in all fields!', 'danger');
                return;
            }
            
            const data = {
                name: name,
                color: color,
                shift: shift,
                active: true
            };
            
            fetch('/api/staff-members', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Staff member added successfully!', 'success');
                    loadStaffMembers();
                    loadPorterRota(); // Reload rota to reflect changes
                    loadTodaySchedule(); // Reload schedule
                }
            })
            .catch(error => {
                showAlert('Error adding staff: ' + error, 'danger');
            });
        }
        
        function cancelAddStaff(shift) {
            const container = shift === 1 ? document.getElementById('shift1Legend') : 
                             shift === 2 ? document.getElementById('shift2Legend') : 
                             document.getElementById('shift3Legend');
            const form = container.querySelector('.staff-edit-form');
            if (form) {
                form.remove();
            }
        }
        
        function editStaff(staffId) {
            // Require PIN authentication first
            requirePinAuth(() => {
                const staffItem = document.getElementById(`staff-${staffId}`);
                if (!staffItem) return;
                
                // Get current values
                const contentDiv = staffItem.querySelector('.legend-item-content span');
                const currentName = contentDiv.textContent.trim();
                const currentShift = parseInt(staffItem.getAttribute('data-shift'));
                const currentColor = staffItem.getAttribute('data-color');
                
                // Build color options based on shift
                let colorOptions = '';
                if (currentShift === 3) {
                    // Night shift colors
                    colorOptions = `
                        <option value="purple" ${currentColor === 'purple' ? 'selected' : ''}>Purple</option>
                        <option value="darkred" ${currentColor === 'darkred' ? 'selected' : ''}>Dark Red</option>
                        <option value="darkgreen" ${currentColor === 'darkgreen' ? 'selected' : ''}>Dark Green</option>
                        <option value="brownishyellow" ${currentColor === 'brownishyellow' ? 'selected' : ''}>Brownish Yellow</option>
                    `;
                } else {
                    // Day shift colors
                    colorOptions = `
                        <option value="red" ${currentColor === 'red' ? 'selected' : ''}>Red</option>
                        <option value="yellow" ${currentColor === 'yellow' ? 'selected' : ''}>Yellow</option>
                        <option value="green" ${currentColor === 'green' ? 'selected' : ''}>Green</option>
                        <option value="blue" ${currentColor === 'blue' ? 'selected' : ''}>Blue</option>
                    `;
                }
                
                // Replace with edit form
                staffItem.innerHTML = `
                    <div class="staff-edit-form">
                        <input type="text" id="edit-staff-name-${staffId}" value="${currentName}" required>
                        <select id="edit-staff-color-${staffId}" required>
                            ${colorOptions}
                        </select>
                        <div class="staff-edit-form-buttons">
                            <button class="btn btn-sm btn-success" onclick="saveStaffEdit(${staffId})">Save</button>
                            <button class="btn btn-sm btn-secondary" onclick="loadStaffMembers()">Cancel</button>
                        </div>
                    </div>
                `;
            });
        }
        
        function saveStaffEdit(staffId) {
            const name = document.getElementById(`edit-staff-name-${staffId}`).value.trim();
            const color = document.getElementById(`edit-staff-color-${staffId}`).value;
            
            if (!name || !color) {
                showAlert('Please fill in all fields!', 'danger');
                return;
            }
            
            const data = {
                name: name,
                color: color
            };
            
            fetch(`/api/staff-members/${staffId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Staff member updated successfully!', 'success');
                    loadStaffMembers();
                    loadPorterRota(); // Reload rota to reflect changes
                    loadTodaySchedule(); // Reload schedule
                }
            })
            .catch(error => {
                showAlert('Error updating staff: ' + error, 'danger');
            });
        }
        
        function deleteStaff(staffId) {
            // Require PIN authentication first
            requirePinAuth(() => {
                if (!confirm('Are you sure you want to remove this staff member? They will be marked as inactive.')) {
                    return;
                }
                
                fetch(`/api/staff-members/${staffId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('Staff member removed successfully!', 'success');
                        loadStaffMembers();
                        loadPorterRota(); // Reload rota to reflect changes
                        loadTodaySchedule(); // Reload schedule
                    }
                })
                .catch(error => {
                    showAlert('Error removing staff: ' + error, 'danger');
                });
            });
        }

        // Tab switching
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            currentTab = tabName;
            
            // Auto-focus PIN input when settings tab is opened
            if (tabName === 'settings') {
                setTimeout(() => {
                    const pinInput = document.getElementById('settings_pin_code');
                    if (pinInput && document.getElementById('settingsPinOverlay').style.display !== 'none') {
                        pinInput.focus();
                    }
                }, 100);
            }
        }


        function loadTodaySchedule() {
            const today = new Date().toISOString().split('T')[0];
            
            // Load staff members, today's schedule, and leave data
            Promise.all([
                fetch('/api/staff-members').then(r => r.json()),
                fetch(`/api/porter-rota?start_date=${today}&end_date=${today}`).then(r => r.json()),
                fetch(`/api/staff-rota?start_date=${today}&end_date=${today}`).then(r => r.json())
            ])
            .then(([staffMembers, rotaData, leaveData]) => {
                const container = document.getElementById('todaySchedule');
                
                if (rotaData.length === 0) {
                    container.innerHTML = '<p style="color: #666;">Unable to load staff schedule</p>';
                    return;
                }
                
                const todayData = rotaData[0];
                
                // Group staff by shift
                const allStaff = {
                    'Shift 1': staffMembers.filter(s => s.shift === 1),
                    'Shift 2': staffMembers.filter(s => s.shift === 2),
                    'Night Shift': staffMembers.filter(s => s.shift === 3)
                };
                
                // Get which staff are off today (regular rotation)
                const staffOffNames = (todayData.staff_off || []).map(s => s.name);
                
                // Create a map of leave status for today
                const leaveMap = {};
                leaveData.forEach(leave => {
                    leaveMap[leave.staff_name] = leave.status; // 'holiday' or 'sick'
                });
                
                let html = '<div class="schedule-container">';
                
                // Create shift boxes - always show all three shifts
                ['Shift 1', 'Shift 2', 'Night Shift'].forEach(shiftName => {
                    html += `<div class="shift-box"><div class="shift-title">${shiftName}</div>`;
                    
                    if (!allStaff[shiftName] || allStaff[shiftName].length === 0) {
                        html += '<span style="font-size: 13px; color: #666;">No staff assigned</span>';
                    } else {
                        allStaff[shiftName].forEach(staff => {
                            // Check if this staff member has leave or is off today
                            let statusClass, statusText;
                            
                            if (leaveMap[staff.name] === 'holiday') {
                                statusClass = 'status-holiday';
                                statusText = 'HOLIDAY';
                            } else if (leaveMap[staff.name] === 'sick') {
                                statusClass = 'status-sick';
                                statusText = 'SICK';
                            } else if (staffOffNames.includes(staff.name)) {
                                statusClass = 'status-off';
                                statusText = 'OFF';
                            } else {
                                statusClass = 'status-working';
                                statusText = 'ON';
                            }
                            
                            html += `<div class="staff-member">
                                <span class="staff-name">${staff.name}</span>
                                <span class="staff-status ${statusClass}">${statusText}</span>
                            </div>`;
                        });
                    }
                    
                    html += '</div>';
                });
                
                html += '</div>';
                container.innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading schedule:', error);
                document.getElementById('todaySchedule').innerHTML = '<p style="color: #666;">Unable to load staff schedule</p>';
            });
        }
        
        function getStatusClass(status) {
            switch(status.toLowerCase()) {
                case 'working': return 'status-working';
                case 'off': return 'status-off';
                case 'holiday': return 'status-holiday';
                case 'sick': return 'status-sick';
                default: return 'status-working';
            }
        }
        
        function getStatusText(status) {
            switch(status.toLowerCase()) {
                case 'working': return 'ON';
                case 'off': return 'OFF';
                case 'holiday': return 'HOLIDAY';
                case 'sick': return 'SICK';
                default: return 'ON';
            }
        }

        function loadDailyOccurrences() {
            fetch('/api/daily-occurrences')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('dailyList');
                
                let html = '<table class="incident-table"><thead><tr><th>TIME</th><th>FLAT</th><th>BY</th><th>INCIDENT REPORT</th><th>ACTIONS</th></tr></thead><tbody>';
                
                // Add empty row for new entry
                html += `<tr id="newRow">
                    <td><input type="time" id="new_time" placeholder="Time"></td>
                    <td><input type="text" id="new_flat" placeholder="Flat (optional)"></td>
                    <td><input type="text" id="new_reported_by" placeholder="Name *"></td>
                    <td><input type="text" id="new_description" placeholder="Incident details... *"></td>
                    <td><button class="btn btn-success btn-sm" onclick="addNewOccurrence()">Add</button></td>
                </tr>`;
                
                // Add existing occurrences
                data.forEach(occurrence => {
                    html += `<tr id="row_${occurrence.id}">
                        <td>${occurrence.time}</td>
                        <td>${occurrence.flat_number}</td>
                        <td>${occurrence.reported_by}</td>
                        <td>${occurrence.description}</td>
                        <td><button class="btn btn-danger btn-sm" onclick="deleteOccurrence(${occurrence.id})">Delete</button></td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
                
                // Setup auto-time fill for new row
                setupNewRowAutoTime();
            });
        }
        
        function setupNewRowAutoTime() {
            const timeField = document.getElementById('new_time');
            const flatField = document.getElementById('new_flat');
            const reportedByField = document.getElementById('new_reported_by');
            
            function autoFillTime() {
                if (!timeField.value) {
                    const now = new Date();
                    const hours = now.getHours().toString().padStart(2, '0');
                    const minutes = now.getMinutes().toString().padStart(2, '0');
                    timeField.value = `${hours}:${minutes}`;
                }
            }
            
            if (flatField) flatField.addEventListener('input', autoFillTime);
            if (reportedByField) reportedByField.addEventListener('input', autoFillTime);
        }
        
        function addNewOccurrence() {
            const time = document.getElementById('new_time').value;
            const flat = document.getElementById('new_flat').value;
            const reportedBy = document.getElementById('new_reported_by').value;
            const description = document.getElementById('new_description').value;
            
            if (!time || !reportedBy || !description) {
                showAlert('Please fill in the required fields (Time, By, and Incident Report)!', 'danger');
                return;
            }
            
            const data = {
                time: time,
                flat_number: flat || '',  // Allow empty flat number
                reported_by: reportedBy,
                description: description
            };
            
            fetch('/api/daily-occurrences', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Occurrence saved successfully! Data is automatically saved to local database.', 'success');
                    // Clear the form
                    document.getElementById('new_time').value = '';
                    document.getElementById('new_flat').value = '';
                    document.getElementById('new_reported_by').value = '';
                    document.getElementById('new_description').value = '';
                    loadDailyOccurrences();
                }
            })
            .catch(error => {
                showAlert('Error adding occurrence: ' + error, 'danger');
            });
        }
        
        function deleteOccurrence(id) {
            if (confirm('Are you sure you want to delete this occurrence?')) {
                fetch(`/api/daily-occurrences/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('Occurrence deleted successfully!', 'success');
                        loadDailyOccurrences();
                    }
                })
                .catch(error => {
                    showAlert('Error deleting occurrence: ' + error, 'danger');
                });
            }
        }

        // Porter Rota - Global variables for navigation
        let currentRotaStartDate = null;
        let currentRotaEndDate = null;
        
        function loadPorterRota(startDate = null, endDate = null) {
            // If no dates provided, load 3 months from today
            if (!startDate || !endDate) {
                const today = new Date();
                startDate = today.toISOString().split('T')[0];
                endDate = new Date(today.getTime() + 90 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            }
            
            // Store current viewing range
            currentRotaStartDate = startDate;
            currentRotaEndDate = endDate;
            
            // Update date range display
            const startDateObj = new Date(startDate);
            const endDateObj = new Date(endDate);
            const dateRangeText = `${startDateObj.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })} - ${endDateObj.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`;
            document.getElementById('rotaDateRange').textContent = dateRangeText;
            
            // Load both porter rota and leave data
            Promise.all([
                fetch(`/api/porter-rota?start_date=${startDate}&end_date=${endDate}`).then(r => r.json()),
                fetch(`/api/staff-rota?start_date=${startDate}&end_date=${endDate}`).then(r => r.json())
            ])
            .then(([data, leaveData]) => {
                // Create a map of leave by date and staff name
                const leaveMap = {};
                leaveData.forEach(leave => {
                    const dateKey = leave.date;
                    if (!leaveMap[dateKey]) {
                        leaveMap[dateKey] = {};
                    }
                    leaveMap[dateKey][leave.staff_name] = leave.status;
                });
                const container = document.getElementById('rotaCalendar');
                
                if (data.length === 0) {
                    container.innerHTML = '<p>No rota data available.</p>';
                    return;
                }
                
                // Group data by month
                const monthGroups = {};
                data.forEach(day => {
                    const date = new Date(day.date);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                    
                    if (!monthGroups[monthKey]) {
                        monthGroups[monthKey] = {
                            name: monthName,
                            days: []
                        };
                    }
                    monthGroups[monthKey].days.push(day);
                });
                
                // Build HTML
                let html = '<div class="rota-calendar">';
                
                Object.keys(monthGroups).sort().forEach(monthKey => {
                    const month = monthGroups[monthKey];
                    
                    html += `<div class="month-section">
                        <div class="month-header">${month.name}</div>
                        <table class="rota-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Day</th>
                                    <th>Week</th>
                                    <th>Staff Off</th>
                                </tr>
                            </thead>
                            <tbody>`;
                    
                    month.days.forEach(day => {
                        const date = new Date(day.date);
                        const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        const rowClass = day.is_today ? 'today-row' : '';
                        const todayIndicator = day.is_today ? '<span class="today-indicator">TODAY</span>' : '';
                        const colorClass = day.color_off ? `color-${day.color_off}` : '';
                        
                        // Build staff cell content with shift information and leave status
                        let staffContent = '';
                        const dateKey = day.date;
                        const dayLeave = leaveMap[dateKey] || {};
                        
                        // Check if anyone has leave on this day
                        const hasLeave = Object.keys(dayLeave).length > 0;
                        
                        if (day.staff_off && day.staff_off.length > 0) {
                            staffContent = '<div class="staff-shift-info">';
                            day.staff_off.forEach(staff => {
                                const shiftTime = staff.shift === 1 ? day.shift1_time : 
                                                  staff.shift === 2 ? day.shift2_time : 
                                                  day.shift3_time;
                                // Determine time badge based on shift time
                                let timeBadge = '07:00-14:00';  // Default early
                                if (shiftTime.includes('Late') || shiftTime.includes('2pm-10pm')) {
                                    timeBadge = '14:00-22:00';
                                } else if (shiftTime.includes('Night') || shiftTime.includes('10pm-7am')) {
                                    timeBadge = '22:00-07:00';
                                }
                                
                                // Check if this staff has leave
                                const leaveStatus = dayLeave[staff.name];
                                let statusBadge = '';
                                if (leaveStatus === 'holiday') {
                                    statusBadge = ' <span style="background: #fff3cd; color: #856404; padding: 2px 6px; border-radius: 3px; font-size: 0.75em; font-weight: 600;">HOLIDAY</span>';
                                } else if (leaveStatus === 'sick') {
                                    statusBadge = ' <span style="background: #e2e3e5; color: #383d41; padding: 2px 6px; border-radius: 3px; font-size: 0.75em; font-weight: 600;">SICK</span>';
                                }
                                
                                staffContent += `<div class="shift-row">
                                    <span class="staff-name-text">${staff.name}${statusBadge}</span>
                                    <span class="shift-badge">${timeBadge}</span>
                                </div>`;
                            });
                            staffContent += '</div>';
                        } else if (hasLeave) {
                            // No regular day off but someone has leave
                            staffContent = '<div class="staff-shift-info">';
                            Object.keys(dayLeave).forEach(staffName => {
                                const leaveStatus = dayLeave[staffName];
                                let statusText = leaveStatus === 'holiday' ? 'HOLIDAY' : 'SICK';
                                let statusColor = leaveStatus === 'holiday' ? '#fff3cd' : '#e2e3e5';
                                let textColor = leaveStatus === 'holiday' ? '#856404' : '#383d41';
                                
                                staffContent += `<div class="shift-row" style="background: ${statusColor}; color: ${textColor}; padding: 5px;">
                                    <span class="staff-name-text" style="font-weight: 600;">${staffName}</span>
                                    <span style="padding: 2px 6px; border-radius: 3px; font-size: 0.75em; font-weight: 600;">${statusText}</span>
                                </div>`;
                            });
                            staffContent += '</div>';
                        } else {
                            // Determine time badges based on shift times
                            let shift1Badge = '07:00-14:00';
                            if (day.shift1_time.includes('Late') || day.shift1_time.includes('2pm-10pm')) {
                                shift1Badge = '14:00-22:00';
                            }
                            let shift2Badge = '07:00-14:00';
                            if (day.shift2_time.includes('Late') || day.shift2_time.includes('2pm-10pm')) {
                                shift2Badge = '14:00-22:00';
                            }
                            let shift3Badge = '22:00-07:00';
                            staffContent = `All working<br><small style="font-size: 0.8em; color: #666;">
                                Shift 1: ${shift1Badge} | Shift 2: ${shift2Badge} | Night: ${shift3Badge}
                            </small>`;
                        }
                        
                        html += `<tr class="${rowClass}">
                            <td class="rota-date-cell">${dateStr}${todayIndicator}</td>
                            <td class="rota-day-cell">${day.day_name}</td>
                            <td class="rota-week-cell">Week ${day.week_in_cycle}</td>
                            <td class="rota-staff-cell ${colorClass}">${staffContent}</td>
                        </tr>`;
                    });
                    
                    html += `</tbody>
                        </table>
                    </div>`;
                });
                
                html += '</div>';
                container.innerHTML = html;
                
                // Scroll to today's row
                setTimeout(() => {
                    const todayRow = document.querySelector('.today-row');
                    if (todayRow) {
                        todayRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            })
            .catch(error => {
                console.error('Error loading porter rota:', error);
                document.getElementById('rotaCalendar').innerHTML = '<p style="color: red;">Error loading rota data</p>';
            });
        }
        
        // Porter Rota Navigation Functions
        function navigateRotaPrevious() {
            if (!currentRotaStartDate) return;
            
            // Go back 3 months (90 days)
            const startDateObj = new Date(currentRotaStartDate);
            const newStartDate = new Date(startDateObj.getTime() - 90 * 24 * 60 * 60 * 1000);
            const newEndDate = new Date(startDateObj.getTime() - 1 * 24 * 60 * 60 * 1000); // Day before current start
            
            loadPorterRota(newStartDate.toISOString().split('T')[0], newEndDate.toISOString().split('T')[0]);
            loadLeaveData(); // Update leave data to match new date range
        }
        
        function navigateRotaNext() {
            if (!currentRotaEndDate) return;
            
            // Go forward 3 months (90 days)
            const endDateObj = new Date(currentRotaEndDate);
            const newStartDate = new Date(endDateObj.getTime() + 1 * 24 * 60 * 60 * 1000); // Day after current end
            const newEndDate = new Date(endDateObj.getTime() + 90 * 24 * 60 * 60 * 1000);
            
            loadPorterRota(newStartDate.toISOString().split('T')[0], newEndDate.toISOString().split('T')[0]);
            loadLeaveData(); // Update leave data to match new date range
        }
        
        function navigateRotaToday() {
            // Jump back to today and load 3 months forward
            const today = new Date();
            const startDate = today.toISOString().split('T')[0];
            const endDate = new Date(today.getTime() + 90 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            loadPorterRota(startDate, endDate);
            loadLeaveData(); // Update leave data to match new date range
        }

        // CCTV/Intercom Faults
        document.getElementById('faultForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const data = {
                fault_type: document.getElementById('fault_type').value,
                flat_number: document.getElementById('flat_number').value,
                block_number: document.getElementById('block_number').value || '',
                floor_number: document.getElementById('floor_number').value || '',
                description: document.getElementById('fault_description_type').value,
                contact_details: document.getElementById('contact_details').value || '',
                additional_notes: document.getElementById('additional_notes').value || ''
            };

            fetch('/api/cctv-faults', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Fault reported successfully!', 'success');
                    document.getElementById('faultForm').reset();
                    loadCCTVFaults();
                }
            })
            .catch(error => {
                showAlert('Error reporting fault: ' + error, 'danger');
            });
        });

        function loadCCTVFaults() {
            fetch('/api/cctv-faults')
            .then(response => response.json())
            .then(data => {
                allFaults = data;
                displayFaults(currentFaultFilter);
            })
            .catch(error => {
                console.error('Error loading faults:', error);
                document.getElementById('faultList').innerHTML = '<p style="color: red;">Error loading fault data</p>';
            });
        }
        
        function displayFaults(filter) {
            const container = document.getElementById('faultList');
            const statsContainer = document.getElementById('faultStats');
            
            // Filter faults based on current filter
            let filteredFaults = allFaults;
            if (filter !== 'all') {
                filteredFaults = allFaults.filter(f => f.fault_type === filter);
            }
            
            // Apply search filter
            if (currentSearchText.trim() !== '') {
                const searchLower = currentSearchText.toLowerCase();
                filteredFaults = filteredFaults.filter(f => {
                    return f.id.toString().includes(searchLower) ||
                           (f.flat_number && f.flat_number.toLowerCase().includes(searchLower)) ||
                           (f.block_number && f.block_number.toLowerCase().includes(searchLower)) ||
                           (f.floor_number && f.floor_number.toLowerCase().includes(searchLower)) ||
                           (f.location && f.location.toLowerCase().includes(searchLower)) ||
                           (f.description && f.description.toLowerCase().includes(searchLower)) ||
                           (f.contact_details && f.contact_details.toLowerCase().includes(searchLower)) ||
                           (f.additional_notes && f.additional_notes.toLowerCase().includes(searchLower)) ||
                           f.fault_type.toLowerCase().includes(searchLower);
                });
            }
            
            // Update stats based on filtered data
            const openCount = filteredFaults.filter(f => f.status === 'open').length;
            const inProgressCount = filteredFaults.filter(f => f.status === 'in_progress').length;
            const closedCount = filteredFaults.filter(f => f.status === 'closed').length;
            
            statsContainer.innerHTML = `
                <div class="fault-stat-item">üî¥ ${openCount} Open</div>
                <div class="fault-stat-item">üîµ ${inProgressCount} In Progress</div>
                <div class="fault-stat-item">üü¢ ${closedCount} Closed</div>
            `;
            
            // Update fault list
            if (filteredFaults.length === 0) {
                const filterName = filter === 'all' ? '' : ` (${filter})`;
                container.innerHTML = `
                    <div class="fault-empty-state">
                        <div class="fault-empty-state-icon">‚úÖ</div>
                        <h4>No Faults Reported${filterName}</h4>
                        <p>All systems are operating normally</p>
                    </div>
                `;
                return;
            }

            let html = '';
            filteredFaults.forEach(fault => {
                const timestamp = new Date(fault.timestamp);
                const timeStr = timestamp.toLocaleString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const typeIcon = fault.fault_type === 'CCTV' ? 'üìπ' : 'üìû';
                const typeBadgeClass = fault.fault_type === 'Intercom' ? 'intercom' : '';
                
                let actionButtons = '';
                if (fault.status === 'open') {
                    actionButtons = `
                        <button class="btn-fault-action btn-fault-progress" onclick="updateFaultStatus(${fault.id}, 'in_progress')">
                            üîÑ In Progress
                        </button>
                        <button class="btn-fault-action btn-fault-close" onclick="updateFaultStatus(${fault.id}, 'closed')">
                            ‚úì Resolve
                        </button>
                    `;
                } else if (fault.status === 'in_progress') {
                    actionButtons = `
                        <button class="btn-fault-action btn-fault-close" onclick="updateFaultStatus(${fault.id}, 'closed')">
                            ‚úì Resolve
                        </button>
                        <button class="btn-fault-action btn-fault-reopen" onclick="updateFaultStatus(${fault.id}, 'open')">
                            ‚Ü© Reopen
                        </button>
                    `;
                } else if (fault.status === 'closed') {
                    actionButtons = `
                        <button class="btn-fault-action btn-fault-reopen" onclick="updateFaultStatus(${fault.id}, 'open')">
                            ‚Ü© Reopen
                        </button>
                    `;
                }
                
                // Build location string from flat, block, floor
                const locationParts = [];
                if (fault.flat_number) locationParts.push(`Flat ${fault.flat_number}`);
                if (fault.block_number) locationParts.push(`Block ${fault.block_number}`);
                if (fault.floor_number) locationParts.push(`Floor ${fault.floor_number}`);
                const locationStr = locationParts.length > 0 ? locationParts.join(' | ') : (fault.location || 'N/A');
                
                const contactInfo = fault.contact_details ? `<div class="fault-contact">üìû Contact: ${fault.contact_details}</div>` : '';
                const additionalNotes = fault.additional_notes ? `<div class="fault-notes">üìù ${fault.additional_notes}</div>` : '';
                
                html += `
                    <div class="fault-item" data-fault-type="${fault.fault_type}">
                        <div class="fault-item-header">
                            <span class="fault-type-badge ${typeBadgeClass}">${typeIcon} ${fault.fault_type}</span>
                            <span class="fault-timestamp">‚è∞ ${timeStr}</span>
                        </div>
                        <div class="fault-location"><span class="screen-only">üìç </span>${locationStr}</div>
                        <div class="fault-description"><strong>Fault:</strong> ${fault.description}</div>
                        ${contactInfo}
                        ${additionalNotes}
                        <div class="fault-actions">
                            <span class="fault-status-badge status-${fault.status.replace('_', '-')}">${fault.status.replace('_', ' ')}</span>
                            ${actionButtons}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function filterFaults(filter) {
            currentFaultFilter = filter;
            
            // Update active button
            document.querySelectorAll('.fault-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
            
            // Display filtered faults
            displayFaults(filter);
        }
        
        function printFaults() {
            const faultList = document.getElementById('faultList');
            const filterName = currentFaultFilter === 'all' ? 'All Faults' : `${currentFaultFilter} Faults`;
            const printDate = new Date().toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Filter faults based on current filter ONLY (ignore search for printing all)
            let faultsToDisplay = allFaults;
            if (currentFaultFilter !== 'all') {
                faultsToDisplay = allFaults.filter(f => f.fault_type === currentFaultFilter);
            }
            // Note: We're NOT applying search filter here so ALL faults print
            // If you want to respect search, uncomment the block below:
            /*
            if (currentSearchText.trim() !== '') {
                const searchLower = currentSearchText.toLowerCase();
                faultsToDisplay = faultsToDisplay.filter(fault => {
                    const locationParts = [];
                    if (fault.flat_number) locationParts.push(`Flat ${fault.flat_number}`);
                    if (fault.block_number) locationParts.push(`Block ${fault.block_number}`);
                    if (fault.floor_number) locationParts.push(`Floor ${fault.floor_number}`);
                    const locationStr = locationParts.join(' | ').toLowerCase();
                    
                    return fault.id.toString().includes(searchLower) ||
                           locationStr.includes(searchLower) ||
                           fault.description.toLowerCase().includes(searchLower) ||
                           (fault.contact_details && fault.contact_details.toLowerCase().includes(searchLower)) ||
                           (fault.additional_notes && fault.additional_notes.toLowerCase().includes(searchLower));
                });
            }
            */
            
            console.log(`Printing ${faultsToDisplay.length} faults (Total in system: ${allFaults.length})`)
            
            // Create Excel-style table
            let tableHTML = `
                <div class="print-table-container">
                    <div class="print-title">CCTV & Intercom Fault Report - ${filterName}</div>
                    <div class="print-date">${printDate}</div>
                    <table class="fault-print-table">
                        <thead>
                            <tr>
                                <th style="width: 5%;">ID</th>
                                <th style="width: 8%;">Type</th>
                                <th style="width: 12%;">Date/Time</th>
                                <th style="width: 18%;">Location</th>
                                <th style="width: 15%;">Fault</th>
                                <th style="width: 12%;">Contact</th>
                                <th style="width: 20%;">Notes</th>
                                <th style="width: 10%;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Add rows for each fault
            faultsToDisplay.forEach(fault => {
                const timestamp = new Date(fault.timestamp);
                const dateStr = timestamp.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric',
                    year: 'numeric'
                });
                const timeStr = timestamp.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit'
                });
                
                // Build location string
                const locationParts = [];
                if (fault.flat_number) locationParts.push(`Flat ${fault.flat_number}`);
                if (fault.block_number) locationParts.push(`Blk ${fault.block_number}`);
                if (fault.floor_number) locationParts.push(`Flr ${fault.floor_number}`);
                const locationStr = locationParts.join(', ') || 'N/A';
                
                const contact = fault.contact_details || '-';
                const notes = fault.additional_notes || '-';
                const status = fault.status.replace('_', ' ').toUpperCase();
                
                tableHTML += `
                    <tr>
                        <td>${fault.id}</td>
                        <td>${fault.fault_type}</td>
                        <td>${dateStr}<br>${timeStr}</td>
                        <td>${locationStr}</td>
                        <td>${fault.description}</td>
                        <td>${contact}</td>
                        <td>${notes}</td>
                        <td style="font-weight: bold;">${status}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                        </tbody>
                    </table>
                    <div style="margin-top: 20px; font-size: 9pt; text-align: center; color: #666;">
                        Total Faults: ${faultsToDisplay.length}
                    </div>
                </div>
            `;
            
            // Insert table directly in document body to avoid container restrictions
            const printContainer = document.createElement('div');
            printContainer.id = 'faultPrintContainer';
            printContainer.style.display = 'none'; // Hidden on screen
            printContainer.innerHTML = tableHTML;
            document.body.appendChild(printContainer);
            
            // Trigger print
            window.print();
            
            // Remove print table after print dialog closes
            setTimeout(() => {
                printContainer.remove();
            }, 500);
        }

        function updateFaultStatus(faultId, status) {
            fetch('/api/update-fault-status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({id: faultId, status: status})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Fault status updated!', 'success');
                    loadCCTVFaults();
                }
            });
        }

        // Water Temperature
        document.getElementById('tempForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const temperatureValue = document.getElementById('temp_input').value;
            const timeValue = document.getElementById('temp_time').value;
            
            if (!temperatureValue || temperatureValue.trim() === '') {
                showAlert('Please enter a temperature value!', 'danger');
                return;
            }
            
            if (!timeValue) {
                showAlert('Please select a time!', 'danger');
                return;
            }

            const data = {
                temperature: temperatureValue,
                time: timeValue
            };

            fetch('/api/water-temperature', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Temperature recorded successfully!', 'success');
                    document.getElementById('tempForm').reset();
                    loadWaterTemperature();
                } else {
                    showAlert('Error: ' + (data.error || 'Failed to record temperature'), 'danger');
                }
            })
            .catch(error => {
                showAlert('Error recording temperature: ' + error, 'danger');
            });
        });

        // Water Temperature - Global variables
        let currentTempPeriod = 'today';
        
        function loadWaterTemperature() {
            // Load latest temperature for the "Latest Reading" card
            fetch('/api/water-temperature')
            .then(response => response.json())
            .then(data => {
                const currentTempContainer = document.getElementById('currentTemp');
                if (data.length > 0) {
                    const latest = data[0];
                    currentTempContainer.innerHTML = `
                        <div class="temperature-value">${latest.temperature}¬∞C</div>
                        <div class="temperature-time">Last recorded: ${new Date(latest.timestamp).toLocaleString()}</div>
                    `;
                } else {
                    currentTempContainer.innerHTML = '<div class="loading">No temperature data available</div>';
                }
            });
            
            // Load today's temperatures by default
            loadTempPeriod('today');
        }
        
        function loadTempPeriod(period) {
            currentTempPeriod = period;
            
            // Update button styles
            document.querySelectorAll('#btnToday, #btnWeek, #btnLastWeek, #btnMonth, #btnCustom').forEach(btn => {
                btn.className = 'btn btn-secondary';
            });
            
            let dateFrom, dateTo;
            const today = new Date();
            
            if (period === 'custom') {
                document.getElementById('btnCustom').className = 'btn btn-primary';
                document.getElementById('customDateRange').style.display = 'block';
                return;
            } else {
                document.getElementById('customDateRange').style.display = 'none';
            }
            
            switch(period) {
                case 'today':
                    document.getElementById('btnToday').className = 'btn btn-primary';
                    dateFrom = dateTo = today.toISOString().split('T')[0];
                    break;
                case 'week':
                    document.getElementById('btnWeek').className = 'btn btn-primary';
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay()); // Sunday
                    dateFrom = weekStart.toISOString().split('T')[0];
                    dateTo = today.toISOString().split('T')[0];
                    break;
                case 'lastweek':
                    document.getElementById('btnLastWeek').className = 'btn btn-primary';
                    const lastWeekEnd = new Date(today);
                    lastWeekEnd.setDate(today.getDate() - today.getDay() - 1); // Last Saturday
                    const lastWeekStart = new Date(lastWeekEnd);
                    lastWeekStart.setDate(lastWeekEnd.getDate() - 6); // Sunday of last week
                    dateFrom = lastWeekStart.toISOString().split('T')[0];
                    dateTo = lastWeekEnd.toISOString().split('T')[0];
                    break;
                case 'month':
                    document.getElementById('btnMonth').className = 'btn btn-primary';
                    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    dateFrom = monthStart.toISOString().split('T')[0];
                    dateTo = today.toISOString().split('T')[0];
                    break;
            }
            
            loadTempData(dateFrom, dateTo, period);
        }
        
        function loadCustomTempRange() {
            const dateFrom = document.getElementById('temp_date_from').value;
            const dateTo = document.getElementById('temp_date_to').value;
            
            if (!dateFrom || !dateTo) {
                showAlert('Please select both from and to dates', 'danger');
                return;
            }
            
            if (dateFrom > dateTo) {
                showAlert('From date must be before or equal to To date', 'danger');
                return;
            }
            
            loadTempData(dateFrom, dateTo, 'custom');
        }
        
        function loadTempData(dateFrom, dateTo, periodName) {
            const url = `/api/water-temperature?date_from=${dateFrom}&date_to=${dateTo}`;
            
            fetch(url)
            .then(response => response.json())
            .then(data => {
                displayTempStats(data, dateFrom, dateTo, periodName);
                displayTempHistory(data);
            })
            .catch(error => {
                console.error('Error loading temperature data:', error);
                document.getElementById('tempHistory').innerHTML = '<p style="color: red;">Error loading temperature data</p>';
            });
        }
        
        function displayTempStats(data, dateFrom, dateTo, periodName) {
            const statsContainer = document.getElementById('tempStats');
            
            if (data.length === 0) {
                statsContainer.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #666;">No temperature data for this period</p>';
                return;
            }
            
            // Calculate statistics
            const temps = data.map(t => t.temperature);
            const average = (temps.reduce((a, b) => a + b, 0) / temps.length).toFixed(1);
            const min = Math.min(...temps).toFixed(1);
            const max = Math.max(...temps).toFixed(1);
            const count = temps.length;
            
            // Calculate date range string
            let rangeStr = '';
            if (dateFrom === dateTo) {
                rangeStr = new Date(dateFrom).toLocaleDateString();
            } else {
                rangeStr = `${new Date(dateFrom).toLocaleDateString()} - ${new Date(dateTo).toLocaleDateString()}`;
            }
            
            statsContainer.innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 5px;">Period</div>
                    <div style="font-size: 1.1em; font-weight: 600;">${periodName === 'custom' ? 'Custom' : periodName.charAt(0).toUpperCase() + periodName.slice(1)}</div>
                    <div style="font-size: 0.8em; opacity: 0.8; margin-top: 5px;">${rangeStr}</div>
                </div>
                <div style="background: #28a745; color: white; padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 5px;">Average</div>
                    <div style="font-size: 2em; font-weight: bold;">${average}¬∞C</div>
                </div>
                <div style="background: #17a2b8; color: white; padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 5px;">Minimum</div>
                    <div style="font-size: 2em; font-weight: bold;">${min}¬∞C</div>
                </div>
                <div style="background: #dc3545; color: white; padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 5px;">Maximum</div>
                    <div style="font-size: 2em; font-weight: bold;">${max}¬∞C</div>
                </div>
                <div style="background: #ffc107; color: #333; padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 0.9em; opacity: 0.8; margin-bottom: 5px;">Readings</div>
                    <div style="font-size: 2em; font-weight: bold;">${count}</div>
                </div>
            `;
        }
        
        function displayTempHistory(data) {
            const historyContainer = document.getElementById('tempHistory');
            
            if (data.length === 0) {
                historyContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No temperature data for this period</p>';
                return;
            }
            
            let html = '<table class="table"><thead style="position: sticky; top: 0; background: #f8f9fa; z-index: 1;"><tr><th>Date</th><th>Time</th><th>Temperature</th></tr></thead><tbody>';
            data.forEach(temp => {
                const date = new Date(temp.timestamp);
                html += `<tr>
                    <td style="white-space: nowrap;">${date.toLocaleDateString()}</td>
                    <td style="font-weight: 600;">${temp.time_recorded}</td>
                    <td style="font-size: 1.1em; color: #007bff;"><strong>${temp.temperature}¬∞C</strong></td>
                </tr>`;
            });
            html += '</tbody></table>';
            historyContainer.innerHTML = html;
        }

        // Settings Management
        document.getElementById('settingsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validate recipient email addresses
            const recipientEmails = document.getElementById('recipient_email').value;
            const emailList = recipientEmails.split(',').map(e => e.trim()).filter(e => e.length > 0);
            
            // Simple email validation regex
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const invalidEmails = emailList.filter(email => !emailRegex.test(email));
            
            if (invalidEmails.length > 0) {
                showAlert('Invalid email address(es): ' + invalidEmails.join(', '), 'danger');
                return;
            }
            
            if (emailList.length === 0) {
                showAlert('Please enter at least one recipient email address', 'danger');
                return;
            }
            
            // Validate sender email
            const senderEmail = document.getElementById('sender_email').value;
            if (!emailRegex.test(senderEmail)) {
                showAlert('Invalid sender email address', 'danger');
                return;
            }
            
            const data = {
                email_time: document.getElementById('email_time').value,
                email_enabled: document.getElementById('email_enabled').checked,
                recipient_email: document.getElementById('recipient_email').value,
                sender_email: document.getElementById('sender_email').value,
                sender_password: document.getElementById('sender_password').value,
                smtp_server: document.getElementById('smtp_server').value,
                smtp_port: document.getElementById('smtp_port').value,
                staff_name: settingsUnlockedStaff || 'Unknown'
            };

            fetch('/api/schedule-settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const emailCount = emailList.length;
                    const message = emailCount > 1 
                        ? `Settings saved successfully! Reports will be sent to ${emailCount} recipients.`
                        : 'Settings saved successfully!';
                    showAlert(message, 'success');
                    loadScheduleSettings();
                }
            })
            .catch(error => {
                showAlert('Error saving settings: ' + error, 'danger');
            });
        });

        function loadScheduleSettings() {
            fetch('/api/schedule-settings')
            .then(response => response.json())
            .then(data => {
                // Populate form
                document.getElementById('email_time').value = data.email_time;
                document.getElementById('email_enabled').checked = data.email_enabled;
                document.getElementById('recipient_email').value = data.recipient_email;
                
                // Populate sender email settings
                document.getElementById('sender_email').value = data.sender_email || '';
                document.getElementById('sender_password').value = data.sender_password || '';
                document.getElementById('smtp_server').value = data.smtp_server || 'smtp.gmail.com';
                document.getElementById('smtp_port').value = data.smtp_port || 587;
                
                // Update current settings display
                const container = document.getElementById('currentSettings');
                const statusText = data.email_enabled ? 'Enabled' : 'Disabled';
                const statusClass = data.email_enabled ? 'status-working' : 'status-off';
                
                // Mask the password for display (show only first 2 and last 2 chars)
                const maskedPassword = data.sender_password ? 
                    data.sender_password.substring(0, 2) + '****' + data.sender_password.substring(data.sender_password.length - 2) :
                    'Not set';
                
                container.innerHTML = `
                    <div class="card">
                        <p><strong>Email Time:</strong> ${data.email_time}</p>
                        <p><strong>Status:</strong> <span class="status-badge ${statusClass}">${statusText}</span></p>
                        <p><strong>Recipient:</strong> ${data.recipient_email}</p>
                        <p><strong>Sender Email:</strong> ${data.sender_email || 'Not configured'}</p>
                        <p><strong>Sender Password:</strong> ${maskedPassword}</p>
                        <p><strong>SMTP Server:</strong> ${data.smtp_server}:${data.smtp_port}</p>
                        <p><strong>Last Updated:</strong> ${new Date(data.last_updated).toLocaleString()}</p>
                    </div>
                `;
            });
        }

        
        function loadEmailHistory() {
            fetch('/api/email-logs')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('emailHistory');
                
                if (data.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666;">No emails sent yet.</p>';
                    return;
                }
                
                // Add count badge
                const countBadge = data.length > 5 ? 
                    `<div style="background: #007bff; color: white; padding: 5px 12px; border-radius: 15px; display: inline-block; font-size: 0.85em; margin-bottom: 10px;">
                        Total: ${data.length} emails sent
                    </div>` : '';
                
                let html = countBadge + '<table class="table" style="margin-bottom: 0;"><thead style="position: sticky; top: 0; background: #f8f9fa; z-index: 1;"><tr><th>Date & Time</th><th>Recipient(s)</th><th>Subject</th><th>PDF File</th></tr></thead><tbody>';
                data.forEach((log, index) => {
                    const sentDate = new Date(log.sent_date);
                    const dateStr = sentDate.toLocaleDateString();
                    const timeStr = sentDate.toLocaleTimeString();
                    const fileName = log.pdf_path.split('\\').pop().split('/').pop();
                    
                    // Highlight recent emails (first 5)
                    const rowStyle = index < 5 ? 'background: #f0f8ff;' : '';
                    
                    html += `<tr style="${rowStyle}">
                        <td style="white-space: nowrap;">${dateStr}<br/><small style="color: #666;">${timeStr}</small></td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="${log.recipient}">${log.recipient}</td>
                        <td>${log.subject}</td>
                        <td><small style="font-family: monospace;">${fileName}</small></td>
                    </tr>`;
                });
                html += '</tbody></table>';
                container.innerHTML = html;
            })
            .catch(error => {
                document.getElementById('emailHistory').innerHTML = '<p style="color: red;">Error loading email history</p>';
            });
        }

        function testEmail() {
            if (!document.getElementById('email_enabled').checked) {
                showAlert('Please enable email sending first!', 'danger');
                return;
            }
            
            const recipient = document.getElementById('recipient_email').value;
            if (!recipient) {
                showAlert('Please enter a recipient email address!', 'danger');
                return;
            }
            
            showAlert('Test email functionality would be implemented here. For now, save your settings and the scheduled email will work at the set time.', 'success');
        }

        function testExport() {
            fetch('/api/test-export', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('PDF exported successfully! Check the reports folder.', 'success');
                } else {
                    showAlert('Export failed: ' + (data.error || 'Unknown error'), 'danger');
                }
            })
            .catch(error => {
                showAlert('Export error: ' + error, 'danger');
            });
        }

        function testClear() {
            if (confirm('Are you sure you want to clear all today\'s diary entries? This action cannot be undone!')) {
                fetch('/api/test-clear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('Diary cleared successfully! ' + data.count + ' entries removed.', 'success');
                        // Reload the daily occurrences to show empty table
                        loadDailyOccurrences();
                    } else {
                        showAlert('Clear failed: ' + (data.error || 'Unknown error'), 'danger');
                    }
                })
                .catch(error => {
                    showAlert('Clear error: ' + error, 'danger');
                });
            }
        }

        // Holiday and Sick Leave Management
        function handleHolidaySubmit(e) {
            e.preventDefault();
            const staffName = document.getElementById('holiday_staff').value;
            const dateFrom = document.getElementById('holiday_date_from').value;
            const dateTo = document.getElementById('holiday_date_to').value;
            const notes = document.getElementById('holiday_notes').value;
            
            if (!staffName || !dateFrom || !dateTo) {
                showAlert('Please fill in all required fields!', 'danger');
                return;
            }
            
            // Validate date range
            if (new Date(dateTo) < new Date(dateFrom)) {
                showAlert('To Date must be after or equal to From Date!', 'danger');
                return;
            }
            
            const data = {
                staff_name: staffName,
                date_from: dateFrom,
                date_to: dateTo,
                status: 'holiday',
                notes: notes
            };
            
            fetch('/api/staff-rota-range', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const days = data.days_added || 1;
                    showAlert(`Holiday added successfully! ${days} day(s) booked.`, 'success');
                    document.getElementById('holidayForm').reset();
                    loadLeaveData();
                    loadTodaySchedule(); // Refresh today's schedule
                    loadPorterRota(); // Refresh calendar
                }
            })
            .catch(error => {
                showAlert('Error adding holiday: ' + error, 'danger');
            });
        }
        
        function handleSickSubmit(e) {
            e.preventDefault();
            const staffName = document.getElementById('sick_staff').value;
            const dateFrom = document.getElementById('sick_date_from').value;
            const dateTo = document.getElementById('sick_date_to').value;
            const notes = document.getElementById('sick_notes').value;
            
            if (!staffName || !dateFrom || !dateTo) {
                showAlert('Please fill in all required fields!', 'danger');
                return;
            }
            
            // Validate date range
            if (new Date(dateTo) < new Date(dateFrom)) {
                showAlert('To Date must be after or equal to From Date!', 'danger');
                return;
            }
            
            const data = {
                staff_name: staffName,
                date_from: dateFrom,
                date_to: dateTo,
                status: 'sick',
                notes: notes
            };
            
            fetch('/api/staff-rota-range', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const days = data.days_added || 1;
                    showAlert(`Sick leave added successfully! ${days} day(s) booked.`, 'success');
                    document.getElementById('sickForm').reset();
                    loadLeaveData();
                    loadTodaySchedule(); // Refresh today's schedule
                    loadPorterRota(); // Refresh calendar
                }
            })
            .catch(error => {
                showAlert('Error adding sick leave: ' + error, 'danger');
            });
        }
        
        function loadLeaveData() {
            // Use current rota viewing range if available, otherwise default to today + 90 days
            let startDate, endDate;
            if (currentRotaStartDate && currentRotaEndDate) {
                startDate = currentRotaStartDate;
                endDate = currentRotaEndDate;
            } else {
                const today = new Date().toISOString().split('T')[0];
                const futureDate = new Date();
                futureDate.setDate(futureDate.getDate() + 90);
                startDate = today;
                endDate = futureDate.toISOString().split('T')[0];
            }
            
            fetch(`/api/staff-rota?start_date=${startDate}&end_date=${endDate}`)
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('leaveList');
                
                if (data.length === 0) {
                    const startDateObj = new Date(startDate);
                    const endDateObj = new Date(endDate);
                    const rangeText = `${startDateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} - ${endDateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
                    container.innerHTML = `<p style="color: #666; font-size: 0.95em;">No leave entries for ${rangeText}.</p>`;
                    return;
                }
                
                // Group consecutive days into ranges
                const grouped = groupLeaveRanges(data);
                
                let html = '<table class="table" style="font-size: 0.9em;"><thead><tr><th>Date Range</th><th>Days</th><th>Staff Member</th><th>Status</th><th>Notes</th><th>Actions</th></tr></thead><tbody>';
                
                grouped.forEach(group => {
                    const statusClass = group.status === 'holiday' ? 'status-holiday' : 'status-sick';
                    const statusText = group.status === 'holiday' ? 'HOLIDAY' : 'SICK';
                    const deleteIds = group.ids.join(',');
                    
                    html += `<tr>
                        <td style="white-space: nowrap;"><strong>${group.dateRange}</strong></td>
                        <td style="text-align: center;">${group.days}</td>
                        <td><strong>${group.staff_name}</strong></td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${group.notes || '-'}</td>
                        <td><button class="btn btn-sm btn-danger" onclick="deleteLeaveRange('${deleteIds}')">Delete</button></td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading leave data:', error);
                document.getElementById('leaveList').innerHTML = '<p style="color: red;">Error loading leave data</p>';
            });
        }
        
        function groupLeaveRanges(data) {
            // Sort by staff, status, and date
            data.sort((a, b) => {
                if (a.staff_name !== b.staff_name) return a.staff_name.localeCompare(b.staff_name);
                if (a.status !== b.status) return a.status.localeCompare(b.status);
                return new Date(a.date) - new Date(b.date);
            });
            
            const groups = [];
            let currentGroup = null;
            
            data.forEach(leave => {
                const leaveDate = new Date(leave.date);
                
                if (!currentGroup || 
                    currentGroup.staff_name !== leave.staff_name || 
                    currentGroup.status !== leave.status ||
                    currentGroup.notes !== leave.notes ||
                    (leaveDate - currentGroup.lastDate) > 86400000) { // More than 1 day gap
                    
                    // Start new group
                    if (currentGroup) {
                        groups.push(formatGroup(currentGroup));
                    }
                    
                    currentGroup = {
                        staff_name: leave.staff_name,
                        status: leave.status,
                        notes: leave.notes,
                        dates: [leaveDate],
                        ids: [leave.id],
                        lastDate: leaveDate
                    };
                } else {
                    // Add to current group
                    currentGroup.dates.push(leaveDate);
                    currentGroup.ids.push(leave.id);
                    currentGroup.lastDate = leaveDate;
                }
            });
            
            // Add last group
            if (currentGroup) {
                groups.push(formatGroup(currentGroup));
            }
            
            return groups;
        }
        
        function formatGroup(group) {
            const dates = group.dates.sort((a, b) => a - b);
            const firstDate = dates[0];
            const lastDate = dates[dates.length - 1];
            
            let dateRange;
            if (dates.length === 1) {
                dateRange = firstDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            } else {
                const firstStr = firstDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const lastStr = lastDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                dateRange = `${firstStr} - ${lastStr}`;
            }
            
            return {
                staff_name: group.staff_name,
                status: group.status,
                notes: group.notes,
                dateRange: dateRange,
                days: dates.length,
                ids: group.ids
            };
        }
        
        function deleteLeaveRange(idsString) {
            const ids = idsString.split(',').map(id => parseInt(id));
            const days = ids.length;
            
            if (!confirm(`Are you sure you want to delete this leave entry (${days} day(s))?`)) {
                return;
            }
            
            // Delete all entries in the range
            Promise.all(ids.map(id => 
                fetch(`/api/staff-rota/${id}`, { method: 'DELETE' })
                    .then(r => r.json())
            ))
            .then(results => {
                const allSuccess = results.every(r => r.success);
                if (allSuccess) {
                    showAlert(`Leave entries deleted successfully! (${days} day(s))`, 'success');
                    loadLeaveData();
                    loadTodaySchedule();
                    loadPorterRota();
                } else {
                    showAlert('Some entries failed to delete', 'danger');
                }
            })
            .catch(error => {
                showAlert('Error deleting leave: ' + error, 'danger');
            });
        }
        

        // Utility functions
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const container = document.querySelector('.tab-content.active');
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
    </script>
    
    <!-- PIN Authentication Modal -->
    <div id="pinModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 10px; max-width: 400px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <h3 style="margin-bottom: 20px; color: #2c3e50;">üîê Shift Leader Authentication</h3>
            <p style="color: #6c757d; margin-bottom: 20px; font-size: 0.95em;">Enter your PIN to access staff management</p>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">PIN:</label>
                <input type="password" id="pinInput" placeholder="Enter your PIN" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 5px; font-size: 1.1em; text-align: center; letter-spacing: 2px;" maxlength="10" autofocus>
            </div>
            <div id="pinError" style="color: #dc3545; margin-bottom: 15px; display: none; text-align: center; font-weight: 500;"></div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="cancelPinAuth()" style="padding: 10px 20px; border: 1px solid #6c757d; background: white; color: #6c757d; border-radius: 5px; cursor: pointer; font-size: 1em;">Cancel</button>
                <button onclick="submitPin()" style="padding: 10px 20px; border: none; background: #007bff; color: white; border-radius: 5px; cursor: pointer; font-size: 1em;">Submit</button>
            </div>
        </div>
    </div>
    
    <script>
        // PIN Authentication System
        let pinAuthCallback = null;
        let shiftLeaders = [];
        
        // Load shift leaders on page load
        fetch('/api/shift-leaders')
            .then(response => response.json())
            .then(data => {
                shiftLeaders = data;
                
                // Populate Change PIN form dropdown
                const changePinSelect = document.getElementById('change_pin_name');
                if (changePinSelect) {
                    data.forEach(leader => {
                        const option = document.createElement('option');
                        option.value = leader.name;
                        option.textContent = leader.name;
                        changePinSelect.appendChild(option);
                    });
                }
            })
            .catch(error => console.error('Error loading shift leaders:', error));
        
        function requirePinAuth(callback) {
            pinAuthCallback = callback;
            const modal = document.getElementById('pinModal');
            modal.style.display = 'flex';
            document.getElementById('pinInput').value = '';
            document.getElementById('pinError').style.display = 'none';
            
            // Focus on the PIN input
            setTimeout(() => document.getElementById('pinInput').focus(), 100);
        }
        
        function submitPin() {
            const pin = document.getElementById('pinInput').value.trim();
            const errorDiv = document.getElementById('pinError');
            
            if (!pin) {
                errorDiv.textContent = 'Please enter your PIN';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Verify PIN with server (only send PIN, server will identify the user)
            fetch('/api/verify-pin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ pin: pin })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // PIN verified, close modal and execute callback
                    document.getElementById('pinModal').style.display = 'none';
                    
                    // Optional: Show success message with name
                    if (data.leader && data.leader.name) {
                        console.log('Authenticated as:', data.leader.name);
                    }
                    
                    if (pinAuthCallback) {
                        pinAuthCallback();
                        pinAuthCallback = null;
                    }
                } else {
                    errorDiv.textContent = data.error || 'Invalid PIN';
                    errorDiv.style.display = 'block';
                    // Shake animation for wrong PIN
                    const input = document.getElementById('pinInput');
                    input.style.animation = 'shake 0.5s';
                    setTimeout(() => { input.style.animation = ''; }, 500);
                }
            })
            .catch(error => {
                errorDiv.textContent = 'Error verifying PIN';
                errorDiv.style.display = 'block';
            });
        }
        
        function cancelPinAuth() {
            document.getElementById('pinModal').style.display = 'none';
            pinAuthCallback = null;
        }
        
        // Handle Enter key in PIN input
        document.addEventListener('DOMContentLoaded', function() {
            const pinInput = document.getElementById('pinInput');
            if (pinInput) {
                pinInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        submitPin();
                    }
                });
            }
        });
        
        // PIN Change Functionality
        function handleChangePinSubmit(event) {
            event.preventDefault();
            
            const name = document.getElementById('change_pin_name').value.trim();
            const oldPin = document.getElementById('change_pin_old').value.trim();
            const newPin = document.getElementById('change_pin_new').value.trim();
            const confirmPin = document.getElementById('change_pin_confirm').value.trim();
            
            // Validation
            if (!name) {
                showAlert('Please select your name', 'danger');
                return;
            }
            
            if (!oldPin || !newPin || !confirmPin) {
                showAlert('All fields are required', 'danger');
                return;
            }
            
            if (newPin.length < 4) {
                showAlert('New PIN must be at least 4 digits', 'danger');
                return;
            }
            
            if (newPin !== confirmPin) {
                showAlert('New PIN and confirmation do not match', 'danger');
                return;
            }
            
            // Send request to change PIN
            fetch('/api/change-pin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name,
                    old_pin: oldPin,
                    new_pin: newPin
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('PIN changed successfully! Please remember your new PIN.', 'success');
                    // Clear the form
                    document.getElementById('changePinForm').reset();
                } else {
                    showAlert('Error: ' + (data.error || 'Failed to change PIN'), 'danger');
                }
            })
            .catch(error => {
                showAlert('Error changing PIN: ' + error, 'danger');
            });
        }
    </script>
</body>
</html>
