<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance Diary Form</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <style>
        :root {
            /* Default Green Theme */
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-container: #ffffff;
            --bg-light: #f7fafc;
            --bg-hover: #edf2f7;
            --bg-checkbox-group: #f0f7ed;
            --color-primary: #4A7722;
            --color-primary-hover: #5a8a32;
            --color-text: #333;
            --color-text-light: #2d3748;
            --color-label: #4A7722;
            --border-color: #cbd5e0;
            --border-color-light: #e2e8f0;
            --border-color-primary: #4A7722;
            --shadow-color: rgba(74, 119, 34, 0.2);
            --shadow-color-light: rgba(0,0,0,0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            padding: 20px;
            min-height: 100vh;
            color: var(--color-text);
        }

        .form-container {
            max-width: 900px;
            margin: 30px auto;
            background: var(--bg-container);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px var(--shadow-color-light);
            border: 1px solid var(--border-color);
        }

        .section-label {
            display: block;
            font-size: 1.25rem;
            font-weight: 700;
            padding: 12px 20px;
            margin-bottom: 25px; 
            border-radius: 8px;
            background: var(--color-primary);
            color: #ffffff;
            box-shadow: 0 2px 8px var(--shadow-color);
            border: none;
        }

        .section-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .label {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--color-label);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-field,
        .input-field-small,
        .textarea-field {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            color: var(--color-text-light);
            background: var(--bg-secondary);
            transition: all 0.3s ease;
        }

        .input-field:focus,
        .input-field-small:focus,
        .textarea-field:focus {
            border-color: var(--color-primary);
            outline: none;
            box-shadow: 0 0 0 3px var(--shadow-color);
            background: var(--bg-secondary);
        }

        .textarea-field {
            min-height: 100px;
            resize: vertical;
            background: var(--bg-secondary);
        }
        .textarea-large {
            min-height: 150px;
            background: var(--bg-secondary);
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 0px; 
            margin-bottom: 25px;
            padding: 20px;
            border: 2px solid var(--border-color-primary);
            border-radius: 8px;
            background: var(--bg-checkbox-group);
            box-shadow: inset 0 2px 4px var(--shadow-color);
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item .label {
            margin-bottom: 0;
            cursor: pointer;
            font-weight: 400;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            appearance: none;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            background: var(--bg-secondary);
        }

        .checkbox:checked {
            background: var(--color-primary);
            border-color: var(--color-primary);
            box-shadow: 0 2px 6px var(--shadow-color);
        }

        .checkbox:checked::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ffffff;
            font-size: 12px;
            font-weight: bold;
        }

        .section {
            margin-bottom: 25px; 
        }

        .nav-tabs {
            display: flex;
            background: var(--bg-light);
            border-bottom: 2px solid var(--border-color);
            margin: 0 -30px 30px -30px;
            padding: 0;
        }

        .nav-tab {
            flex: 1;
            padding: 18px 20px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 1.1em;
            font-weight: 600;
            color: #4a5568;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .nav-tab:hover {
            background: var(--bg-hover);
            color: var(--color-primary);
        }

        .nav-tab.active {
            color: var(--color-primary);
            background: var(--bg-secondary);
            border-bottom-color: var(--color-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .back-button {
            display: inline-block;
            padding: 12px 24px;
            background: var(--color-primary);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        .back-button:hover {
            background: var(--color-primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--shadow-color);
            color: white;
        }

        .search-section {
            background: var(--bg-light);
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid var(--border-color-light);
            box-shadow: 0 2px 8px var(--shadow-color-light);
        }

        .search-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .entries-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px var(--shadow-color-light);
            border: 1px solid var(--border-color-light);
        }

        .entries-table thead {
            background: var(--color-primary);
            color: white;
        }

        .entries-table th,
        .entries-table td {
            padding: 14px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color-light);
        }

        .entries-table th {
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.85rem;
        }

        .entries-table tbody tr {
            cursor: pointer;
            transition: background-color 0.2s ease;
            background: var(--bg-secondary);
        }

        .entries-table tbody tr:nth-child(even) {
            background: var(--bg-light);
        }

        .entries-table tbody tr:hover {
            background: var(--bg-hover);
        }

        .entries-table tbody tr.selected {
            background: #e6f5e6;
            border-left: 4px solid var(--color-primary);
        }

        .entry-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .entry-actions {
            display: flex;
            gap: 10px;
        }

        .print-controls {
            background: var(--bg-light);
            padding: 18px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            border: 2px solid var(--border-color-light);
            box-shadow: 0 2px 6px var(--shadow-color-light);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-edit {
            background: var(--color-primary);
            color: white;
            box-shadow: 0 2px 6px var(--shadow-color);
        }

        .btn-edit:hover {
            background: var(--color-primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 3px 10px var(--shadow-color);
        }

        .btn-delete {
            background: #e53e3e;
            color: white;
            box-shadow: 0 2px 6px rgba(229, 62, 62, 0.25);
        }

        .btn-delete:hover {
            background: #c53030;
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(229, 62, 62, 0.35);
        }

        .no-entries {
            text-align: center;
            padding: 40px;
            color: #718096;
            background: var(--bg-light);
            border-radius: 8px;
            border: 2px dashed var(--border-color);
            font-size: 1.1rem;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        .btn-success {
            background: var(--color-primary-hover);
            color: white;
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        .btn-success:hover {
            background: var(--color-primary);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        .btn-secondary {
            background: #718096;
            color: white;
            box-shadow: 0 2px 8px rgba(113, 128, 150, 0.3);
        }

        .btn-secondary:hover {
            background: #4a5568;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(113, 128, 150, 0.4);
        }

        .btn-danger {
            background: #e53e3e;
            color: white;
            box-shadow: 0 2px 8px rgba(229, 62, 62, 0.3);
        }

        .btn-danger:hover {
            background: #c53030;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(229, 62, 62, 0.4);
        }

        /* Color Scheme Switcher */
        .color-scheme-switcher {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 4px 12px var(--shadow-color-light);
        }

        .color-scheme-switcher select {
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--color-text);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            outline: none;
        }

        .color-scheme-switcher select:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px var(--shadow-color);
        }

        @media (max-width: 600px) {
            .form-container {
                margin: 10px;
                padding: 20px;
            }
            .section-grid {
                grid-template-columns: 1fr; 
            }
            .nav-tabs {
                margin: -20px -20px 20px -20px;
            }
            .entries-table {
                font-size: 0.9rem;
            }
            .entries-table th,
            .entries-table td {
                padding: 8px;
            }
            .color-scheme-switcher {
                top: 10px;
                right: 10px;
                padding: 8px;
            }
            .color-scheme-switcher select {
                font-size: 0.8rem;
                padding: 6px 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Color Scheme Switcher -->
    <div class="color-scheme-switcher">
        <label for="colorScheme" style="display: none;">Color Scheme:</label>
        <select id="colorScheme" onchange="changeColorScheme(this.value)">
            <option value="green">Green</option>
            <option value="blue">Blue</option>
            <option value="blue2">Blue 2</option>
            <option value="gold">Gold</option>
        </select>
    </div>

    <div class="form-container">
        <div style="margin-bottom: 30px; padding-bottom: 10px;">
            <a href="/" class="back-button">‚Üê Back to Diary</a>
        </div>

        <!-- Tab Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showDocTab('form', this)">Create/Edit Entry</button>
            <button class="nav-tab" onclick="showDocTab('browse', this)">Browse Entries</button>
        </div>

        <!-- Form Tab -->
        <div id="form-tab" class="tab-content active">
        <div class="section-label">General Job Information</div>
        <div class="section-grid">
            <div class="form-group">
                <label class="label" for="department">Department</label>
                <input type="text" class="input-field" id="department" value="">
            </div>
            <div class="form-group">
                <label class="label" for="id">ID</label>
                <input type="text" class="input-field" id="id" value="">
            </div>
            <div class="form-group">
                <label class="label" for="employee">Employee</label>
                <input type="text" class="input-field" id="employee" value="">
            </div>
        </div>

        <div class="section-grid">
            <div class="form-group">
                <label class="label" for="property">Property</label>
                <input type="text" class="input-field" id="property" value="">
            </div>
            <div class="form-group">
                <label class="label" for="dateIn">Date In</label>
                <input type="date" class="input-field" id="dateIn" value=""> 
            </div>
            <div class="form-group">
                <label class="label" for="timeIn">Time In</label>
                <input type="time" class="input-field" id="timeIn" value="">
            </div>
        </div>
        
        <hr style="border: none; height: 2px; background: var(--color-primary); margin: 30px 0;"/>
        
        <div class="section">
            <div class="section-label">Details of Fault</div>
            <div class="form-group">
                <textarea class="textarea-field textarea-large" id="detailsOfFault" rows="5"></textarea>
            </div>
        </div>

        <div class="section">
            <div class="section-label">Action Taken</div>
            <div class="form-group">
                <textarea class="textarea-field textarea-large" id="actionTaken" rows="5"></textarea>
            </div>
        </div>

        <div class="section-label">Work Status / Details</div>
        <div class="checkbox-group">
            <div class="checkbox-item">
                <input type="checkbox" class="checkbox" id="workCompleted" name="status">
                <label class="label" for="workCompleted">Work Completed</label>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" class="checkbox" id="followUpRequired" name="status">
                <label class="label" for="followUpRequired">Follow-up Required</label>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" class="checkbox" id="partsOrdered" name="status">
                <label class="label" for="partsOrdered">Parts Ordered</label>
            </div>
        </div>
        
        <div class="section-label">Maintenance Completion</div>
        <div class="section-grid">
            <div class="form-group">
                <label class="label" for="maintenanceName">Maintenance Name</label>
                <input type="text" class="input-field" id="maintenanceName" value="">
            </div>
            <div class="form-group">
                <label class="label" for="dateDone">Date Done</label>
                <input type="date" class="input-field" id="dateDone" value="">
            </div>
            <div class="form-group">
                <label class="label" for="timeDone">Time Done</label>
                <input type="time" class="input-field" id="timeDone" value="">
            </div>
        </div>

        <div class="section">
            <div class="section-label">Further Action Details</div>
            <div class="form-group">
                <textarea class="textarea-field textarea-large" id="furtherAction" rows="5"></textarea>
            </div>
        </div>

        <div class="section" style="margin-top: 30px;">
            <button id="saveButton" class="btn btn-primary">Save Entry</button>
            <button id="newButton" class="btn btn-success">New Entry</button>
                    <span id="saveStatus" style="margin-left: 15px; color: var(--color-primary); font-weight: 600; font-size: 1.1rem;"></span>
        </div>
        </div>

        <!-- Browse Entries Tab -->
        <div id="browse-tab" class="tab-content">
            <div class="search-section">
                <h3 style="margin-bottom: 15px; color: var(--color-primary); font-weight: 700;">üîç Search Entries</h3>
                
                <!-- General Search - searches all fields -->
                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="label" for="searchAll" style="font-size: 1rem; color: var(--color-primary); font-weight: 700;">üîç Search All Fields</label>
                    <input type="text" class="input-field" id="searchAll" placeholder="Enter flat number, text, or any keyword to search across all fields..." 
                           style="padding: 12px; font-size: 1rem; border: 2px solid var(--color-primary); background: var(--bg-secondary);" 
                           onkeyup="if(event.key === 'Enter') searchEntries()">
                    <small style="color: #4a5568; margin-top: 5px; display: block; font-weight: 500;">
                        Searches in: Property, Fault Details, Action Taken, Employee, Department, and all other fields
                    </small>
                </div>

                <div class="search-grid">
                    <div class="form-group">
                        <label class="label" for="searchId">ID</label>
                        <input type="text" class="input-field" id="searchId" placeholder="Search by ID">
                    </div>
                    <div class="form-group">
                        <label class="label" for="searchProperty">Property</label>
                        <input type="text" class="input-field" id="searchProperty" placeholder="Search by Property">
                    </div>
                    <div class="form-group">
                        <label class="label" for="searchEmployee">Employee</label>
                        <input type="text" class="input-field" id="searchEmployee" placeholder="Search by Employee">
                    </div>
                    <div class="form-group">
                        <label class="label" for="searchDateFrom">Date From</label>
                        <input type="date" class="input-field" id="searchDateFrom">
                    </div>
                    <div class="form-group">
                        <label class="label" for="searchDateTo">Date To</label>
                        <input type="date" class="input-field" id="searchDateTo">
                    </div>
                </div>
                <button id="searchButton" class="btn btn-primary">Search</button>
                <button id="clearSearchButton" class="btn btn-secondary">Clear</button>
            </div>

            <div class="print-controls">
                <button id="printSelectedButton" class="btn btn-danger" style="display: none;" onclick="printSelectedEntries()">Print Selected (<span id="selectedCount">0</span>)</button>
                <button id="selectAllButton" class="btn btn-secondary" onclick="selectAllEntries()">Select All</button>
                <button id="deselectAllButton" class="btn btn-secondary" onclick="deselectAllEntries()">Deselect All</button>
            </div>

            <div id="entriesList">
                <div class="no-entries">Loading entries...</div>
            </div>
        </div>

    </div>

    <script>
        // Get entry ID from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const entryId = urlParams.get('id');
        let currentEntryId = entryId || null;
        let allEntries = [];

        // Color Schemes
        const colorSchemes = {
            green: {
                '--bg-primary': '#f5f5f5',
                '--bg-secondary': '#ffffff',
                '--bg-container': '#ffffff',
                '--bg-light': '#f7fafc',
                '--bg-hover': '#edf2f7',
                '--bg-checkbox-group': '#f0f7ed',
                '--color-primary': '#4A7722',
                '--color-primary-hover': '#5a8a32',
                '--color-text': '#333',
                '--color-text-light': '#2d3748',
                '--color-label': '#4A7722',
                '--border-color': '#cbd5e0',
                '--border-color-light': '#e2e8f0',
                '--border-color-primary': '#4A7722',
                '--shadow-color': 'rgba(74, 119, 34, 0.2)',
                '--shadow-color-light': 'rgba(0,0,0,0.15)'
            },
            blue: {
                '--bg-primary': '#DFE9EB',
                '--bg-secondary': '#ffffff',
                '--bg-container': '#DFE9EB',
                '--bg-light': '#DFE9EB',
                '--bg-hover': '#ABC3CD',
                '--bg-checkbox-group': '#DFE9EB',
                '--color-primary': '#61828A',
                '--color-primary-hover': '#A9CCCF',
                '--color-text': '#333',
                '--color-text-light': '#2d3748',
                '--color-label': '#61828A',
                '--border-color': '#ABC3CD',
                '--border-color-light': '#ABC3CD',
                '--border-color-primary': '#61828A',
                '--shadow-color': 'rgba(97, 130, 138, 0.3)',
                '--shadow-color-light': 'rgba(97, 130, 138, 0.2)'
            },
            blue2: {
                '--bg-primary': '#D6EAF8',
                '--bg-secondary': '#D6EAF8',
                '--bg-container': '#D6EAF8',
                '--bg-light': '#AED6F1',
                '--bg-hover': '#85C1E9',
                '--bg-checkbox-group': '#AED6F1',
                '--color-primary': '#3498DB',
                '--color-primary-hover': '#5DADE2',
                '--color-text': '#333',
                '--color-text-light': '#2d3748',
                '--color-label': '#3498DB',
                '--border-color': '#85C1E9',
                '--border-color-light': '#85C1E9',
                '--border-color-primary': '#3498DB',
                '--shadow-color': 'rgba(52, 152, 219, 0.3)',
                '--shadow-color-light': 'rgba(52, 152, 219, 0.2)'
            },
            gold: {
                '--bg-primary': '#1a1b26',
                '--bg-secondary': '#1a1b26',
                '--bg-container': '#24283b',
                '--bg-light': '#24283b',
                '--bg-hover': '#1a1b26',
                '--bg-checkbox-group': '#1a1b26',
                '--color-primary': '#7aa2f7',
                '--color-primary-hover': '#9ece6a',
                '--color-text': '#c0caf5',
                '--color-text-light': '#c0caf5',
                '--color-label': '#7aa2f7',
                '--border-color': '#565f89',
                '--border-color-light': '#565f89',
                '--border-color-primary': '#565f89',
                '--shadow-color': 'rgba(122, 162, 247, 0.3)',
                '--shadow-color-light': 'rgba(0, 0, 0, 0.5)'
            }
        };

        // Change color scheme
        function changeColorScheme(schemeName) {
            const scheme = colorSchemes[schemeName];
            if (!scheme) return;

            const root = document.documentElement;
            Object.keys(scheme).forEach(key => {
                root.style.setProperty(key, scheme[key]);
            });

            // Save preference
            localStorage.setItem('docColorScheme', schemeName);
        }

        // Load saved color scheme
        function loadColorScheme() {
            const savedScheme = localStorage.getItem('docColorScheme') || 'green';
            document.getElementById('colorScheme').value = savedScheme;
            changeColorScheme(savedScheme);
        }

        // Tab switching function
        function showDocTab(tabName, clickedElement) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Activate the clicked tab button
            if (clickedElement) {
                clickedElement.classList.add('active');
            } else {
                // If called programmatically, activate the correct tab button
                document.querySelectorAll('.nav-tab').forEach(btn => {
                    if (btn.textContent.includes(tabName === 'form' ? 'Create/Edit' : 'Browse')) {
                        btn.classList.add('active');
                    }
                });
            }

            // Load entries if browsing tab is opened
            if (tabName === 'browse') {
                loadAllEntries();
            }
        }

        // Helper function to format date from database to HTML date input
        function formatDateForInput(dateStr) {
            if (!dateStr) return '';
            const datePart = dateStr.split(' ')[0];
            return datePart;
        }

        // Helper function to format time from database to HTML time input
        function formatTimeForInput(timeStr) {
            if (!timeStr) return '';
            if (timeStr.includes(' ')) {
                const timePart = timeStr.split(' ')[1];
                return timePart.substring(0, 5);
            }
            return timeStr.substring(0, 5);
        }

        // Helper function to format date from HTML input to database format
        function formatDateForDB(dateStr) {
            if (!dateStr) return '';
            return dateStr + ' 00:00:00';
        }

        // Helper function to format time from HTML input to database format
        function formatTimeForDB(timeStr) {
            if (!timeStr) return '';
            return '1899-12-30 ' + timeStr + ':00';
        }

        // Load entry data from API
        async function loadEntry(id) {
            try {
                const response = await fetch(`/api/maintenance-entries?id=${id}`);
                if (!response.ok) {
                    if (response.status === 404) {
                        document.getElementById('saveStatus').textContent = 'Entry not found';
                        return;
                    }
                    throw new Error('Failed to load entry');
                }
                const data = await response.json();
                
                // Populate form fields
                document.getElementById('department').value = data.Department || '';
                document.getElementById('id').value = data.ID || '';
                document.getElementById('employee').value = data.Employee || '';
                document.getElementById('property').value = data.Property || '';
                document.getElementById('dateIn').value = formatDateForInput(data.DateIn);
                document.getElementById('timeIn').value = formatTimeForInput(data.TimeIn);
                document.getElementById('detailsOfFault').value = data['Details of Fault'] || '';
                document.getElementById('actionTaken').value = data['Action taken'] || '';
                document.getElementById('maintenanceName').value = data['Maintenance Name'] || '';
                document.getElementById('dateDone').value = formatDateForInput(data.DateDone);
                document.getElementById('timeDone').value = formatTimeForInput(data.TimeDone);
                document.getElementById('furtherAction').value = data['Further action details'] || '';
                
                currentEntryId = data.ID;
                    document.getElementById('saveStatus').textContent = '‚úì Entry loaded';
                    document.getElementById('saveStatus').style.color = getComputedStyle(document.documentElement).getPropertyValue('--color-primary');
                setTimeout(() => {
                    document.getElementById('saveStatus').textContent = '';
                }, 2000);
            } catch (error) {
                console.error('Error loading entry:', error);
                document.getElementById('saveStatus').textContent = 'Error loading entry: ' + error.message;
            }
        }

        // Save entry to API
        async function saveEntry() {
            const entryData = {
                id: document.getElementById('id').value || null,
                department: document.getElementById('department').value,
                employee: document.getElementById('employee').value,
                property: document.getElementById('property').value,
                dateIn: formatDateForDB(document.getElementById('dateIn').value),
                timeIn: formatTimeForDB(document.getElementById('timeIn').value),
                detailsOfFault: document.getElementById('detailsOfFault').value,
                actionTaken: document.getElementById('actionTaken').value,
                maintenanceName: document.getElementById('maintenanceName').value,
                dateDone: formatDateForDB(document.getElementById('dateDone').value),
                timeDone: formatTimeForDB(document.getElementById('timeDone').value),
                furtherAction: document.getElementById('furtherAction').value,
                hw: '0',
                cw: '0',
                ch: '0'
            };

            try {
                const entryId = document.getElementById('id').value;
                let response;
                
                if (entryId && currentEntryId) {
                    // Update existing entry
                    response = await fetch(`/api/maintenance-entries/${entryId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(entryData)
                    });
                } else {
                    // Create new entry
                    response = await fetch('/api/maintenance-entries', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(entryData)
                    });
                }

                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('saveStatus').textContent = '‚úì Entry saved successfully!';
                    document.getElementById('saveStatus').style.color = getComputedStyle(document.documentElement).getPropertyValue('--color-primary-hover');
                    
                    // Update current entry ID if it was a new entry
                    if (!entryId && result.id) {
                        currentEntryId = result.id;
                        document.getElementById('id').value = result.id;
                    }
                    
                    setTimeout(() => {
                        document.getElementById('saveStatus').textContent = '';
                    }, 3000);
                } else {
                    throw new Error(result.error || 'Failed to save entry');
                }
            } catch (error) {
                console.error('Error saving entry:', error);
                document.getElementById('saveStatus').textContent = '‚úó Error saving entry: ' + error.message;
                document.getElementById('saveStatus').style.color = '#e53e3e';
            }
        }

        // Clear form for new entry
        function newEntry() {
            document.getElementById('department').value = '';
            document.getElementById('id').value = '';
            document.getElementById('employee').value = '';
            document.getElementById('property').value = '';
            document.getElementById('dateIn').value = '';
            document.getElementById('timeIn').value = '';
            document.getElementById('detailsOfFault').value = '';
            document.getElementById('actionTaken').value = '';
            document.getElementById('workCompleted').checked = false;
            document.getElementById('followUpRequired').checked = false;
            document.getElementById('partsOrdered').checked = false;
            document.getElementById('maintenanceName').value = '';
            document.getElementById('dateDone').value = '';
            document.getElementById('timeDone').value = '';
            document.getElementById('furtherAction').value = '';
            currentEntryId = null;
            document.getElementById('saveStatus').textContent = '';
            
            // Update URL to remove ID parameter
            window.history.pushState({}, '', '/doc');
        }

        // Load all entries for browsing
        async function loadAllEntries() {
            try {
                // Load all entries (limit=0 means no limit)
                const response = await fetch('/api/maintenance-entries?limit=0');
                if (!response.ok) {
                    throw new Error('Failed to load entries');
                }
                allEntries = await response.json();
                displayEntries(allEntries);
            } catch (error) {
                console.error('Error loading entries:', error);
                document.getElementById('entriesList').innerHTML = '<div class="no-entries">Error loading entries: ' + error.message + '</div>';
            }
        }

        // Display entries in table
        function displayEntries(entries) {
            const container = document.getElementById('entriesList');
            
            if (!entries || entries.length === 0) {
                container.innerHTML = '<div class="no-entries">No entries found</div>';
                return;
            }

            let html = `
                <table class="entries-table">
                    <thead>
                        <tr>
                            <th style="width: 40px;"><input type="checkbox" class="entry-checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)"></th>
                            <th>ID</th>
                            <th>Property</th>
                            <th>Date In</th>
                            <th>Employee</th>
                            <th>Department</th>
                            <th>Fault Details</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            entries.forEach((entry, index) => {
                const dateIn = formatDateForInput(entry.DateIn || '');
                const faultDetails = (entry['Details of Fault'] || '').substring(0, 50);
                html += `
                    <tr onclick="loadEntryForEdit('${entry.ID}')">
                        <td onclick="event.stopPropagation();">
                            <input type="checkbox" class="entry-checkbox" data-entry-id="${entry.ID}" onchange="updatePrintButton()">
                        </td>
                        <td><strong>${entry.ID || ''}</strong></td>
                        <td>${entry.Property || ''}</td>
                        <td>${dateIn || ''}</td>
                        <td>${entry.Employee || ''}</td>
                        <td>${entry.Department || ''}</td>
                        <td>${faultDetails}${faultDetails.length >= 50 ? '...' : ''}</td>
                        <td>
                            <div class="entry-actions" onclick="event.stopPropagation();">
                                <button class="btn-small btn-edit" onclick="loadEntryForEdit('${entry.ID}')">Edit</button>
                                <button class="btn-small btn-delete" onclick="deleteEntry('${entry.ID}')">Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
                <div style="margin-top: 15px; color: var(--color-primary); text-align: center; font-weight: 600; padding: 10px; background: var(--bg-light); border-radius: 8px; border: 1px solid var(--border-color-light);">
                    Showing ${entries.length} entries
                </div>
            `;

            container.innerHTML = html;
            
            // Reset selection state
            updatePrintButton();
            document.getElementById('selectAllCheckbox').checked = false;
        }

        // Load entry for editing (switches to form tab)
        function loadEntryForEdit(id) {
            // Switch to form tab
            showDocTab('form');
            
            // Load the entry
            loadEntry(id);
        }

        // Delete entry
        async function deleteEntry(id) {
            if (!confirm(`Are you sure you want to delete entry ID ${id}?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/maintenance-entries/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (result.success) {
                    // Reload entries list
                    loadAllEntries();
                    // Clear form if this was the current entry
                    if (currentEntryId === id) {
                        newEntry();
                    }
                } else {
                    alert('Error deleting entry: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting entry:', error);
                alert('Error deleting entry: ' + error.message);
            }
        }

        // Helper function to get all text content from an entry for searching
        function getEntryTextContent(entry) {
            const fields = [
                entry.ID || '',
                entry.Property || '',
                entry.Employee || '',
                entry.Department || '',
                entry['Details of Fault'] || '',
                entry['Action taken'] || '',
                entry['Further action details'] || '',
                entry['Maintenance Name'] || '',
                entry.ContactDetails || '',
                entry.HW || '',
                entry.CW || '',
                entry.CH || ''
            ];
            return fields.join(' ').toLowerCase();
        }

        // Search entries
        function searchEntries() {
            const searchAll = document.getElementById('searchAll').value.toLowerCase().trim();
            const searchId = document.getElementById('searchId').value.toLowerCase();
            const searchProperty = document.getElementById('searchProperty').value.toLowerCase();
            const searchEmployee = document.getElementById('searchEmployee').value.toLowerCase();
            const searchDateFrom = document.getElementById('searchDateFrom').value;
            const searchDateTo = document.getElementById('searchDateTo').value;

            let filtered = allEntries;

            // General search - searches across ALL fields
            if (searchAll) {
                filtered = filtered.filter(e => {
                    const allText = getEntryTextContent(e);
                    return allText.includes(searchAll);
                });
            }

            // Specific field searches (work as additional filters)
            if (searchId) {
                filtered = filtered.filter(e => {
                    // Convert ID to string first, then to lowercase for comparison
                    const entryId = String(e.ID || '').toLowerCase();
                    return entryId.includes(searchId);
                });
            }
            if (searchProperty) {
                filtered = filtered.filter(e => {
                    const property = (e.Property || '').toLowerCase();
                    const faultDetails = (e['Details of Fault'] || '').toLowerCase();
                    return property.includes(searchProperty) || faultDetails.includes(searchProperty);
                });
            }
            if (searchEmployee) {
                filtered = filtered.filter(e => (e.Employee || '').toLowerCase().includes(searchEmployee));
            }
            if (searchDateFrom) {
                filtered = filtered.filter(e => {
                    const dateIn = formatDateForInput(e.DateIn || '');
                    return dateIn >= searchDateFrom;
                });
            }
            if (searchDateTo) {
                filtered = filtered.filter(e => {
                    const dateIn = formatDateForInput(e.DateIn || '');
                    return dateIn <= searchDateTo;
                });
            }

            displayEntries(filtered);
        }

        // Clear search
        function clearSearch() {
            document.getElementById('searchAll').value = '';
            document.getElementById('searchId').value = '';
            document.getElementById('searchProperty').value = '';
            document.getElementById('searchEmployee').value = '';
            document.getElementById('searchDateFrom').value = '';
            document.getElementById('searchDateTo').value = '';
            displayEntries(allEntries);
        }

        // Update print button visibility and count
        function updatePrintButton() {
            const checkboxes = document.querySelectorAll('.entry-checkbox[data-entry-id]');
            const checked = Array.from(checkboxes).filter(cb => cb.checked);
            const printButton = document.getElementById('printSelectedButton');
            const selectedCount = document.getElementById('selectedCount');
            
            if (checked.length > 0) {
                printButton.style.display = 'inline-block';
                selectedCount.textContent = checked.length;
            } else {
                printButton.style.display = 'none';
            }
        }

        // Toggle select all
        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.entry-checkbox[data-entry-id]');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
            updatePrintButton();
        }

        // Select all entries
        function selectAllEntries() {
            const checkboxes = document.querySelectorAll('.entry-checkbox[data-entry-id]');
            checkboxes.forEach(cb => cb.checked = true);
            document.getElementById('selectAllCheckbox').checked = true;
            updatePrintButton();
        }

        // Deselect all entries
        function deselectAllEntries() {
            const checkboxes = document.querySelectorAll('.entry-checkbox[data-entry-id]');
            checkboxes.forEach(cb => cb.checked = false);
            document.getElementById('selectAllCheckbox').checked = false;
            updatePrintButton();
        }

        // Print selected entries
        function printSelectedEntries() {
            const checkboxes = document.querySelectorAll('.entry-checkbox[data-entry-id]:checked');
            if (checkboxes.length === 0) {
                alert('Please select at least one entry to print.');
                return;
            }

            const selectedIds = Array.from(checkboxes).map(cb => cb.getAttribute('data-entry-id'));
            const selectedEntries = allEntries.filter(e => selectedIds.includes(e.ID || ''));

            // Create print window
            const printWindow = window.open('', '_blank');
            
            let printHTML = `
<!DOCTYPE html>
<html>
<head>
    <title>Maintenance Entries - Print</title>
    <style>
        @media print {
            @page {
                margin: 1cm;
            }
            body {
                margin: 0;
            }
        }
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            color: #000;
        }
        h1 {
            text-align: center;
            color: #4A7722;
            margin-bottom: 30px;
            border-bottom: 3px solid #4A7722;
            padding-bottom: 10px;
        }
        .entry {
            page-break-inside: avoid;
            margin-bottom: 30px;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
        }
        .entry-header {
            background: #4A7722;
            color: white;
            padding: 10px;
            margin: -15px -15px 15px -15px;
            border-radius: 5px 5px 0 0;
            font-weight: bold;
        }
        .entry-row {
            margin-bottom: 10px;
            display: flex;
        }
        .entry-label {
            font-weight: bold;
            min-width: 150px;
            color: #555;
        }
        .entry-value {
            flex: 1;
        }
        .entry-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .entry-section-title {
            font-weight: bold;
            color: #4A7722;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #ddd;
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <h1>Maintenance Entries Report</h1>
    <p style="text-align: center; color: #666; margin-bottom: 30px;">Generated: ${new Date().toLocaleString()}</p>
`;

            selectedEntries.forEach((entry, index) => {
                const dateIn = formatDateForInput(entry.DateIn || '');
                const timeIn = formatTimeForInput(entry.TimeIn || '');
                const dateDone = formatDateForInput(entry.DateDone || '');
                const timeDone = formatTimeForInput(entry.TimeDone || '');
                
                printHTML += `
    <div class="entry">
        <div class="entry-header">Entry ID: ${entry.ID || 'N/A'} - ${dateIn || 'No Date'}</div>
        
        <div class="entry-row">
            <span class="entry-label">Property:</span>
            <span class="entry-value">${entry.Property || 'N/A'}</span>
        </div>
        <div class="entry-row">
            <span class="entry-label">Department:</span>
            <span class="entry-value">${entry.Department || 'N/A'}</span>
        </div>
        <div class="entry-row">
            <span class="entry-label">Employee:</span>
            <span class="entry-value">${entry.Employee || 'N/A'}</span>
        </div>
        <div class="entry-row">
            <span class="entry-label">Date In:</span>
            <span class="entry-value">${dateIn || 'N/A'}</span>
        </div>
        <div class="entry-row">
            <span class="entry-label">Time In:</span>
            <span class="entry-value">${timeIn || 'N/A'}</span>
        </div>
        
        <div class="entry-section">
            <div class="entry-section-title">Details of Fault</div>
            <div>${(entry['Details of Fault'] || 'N/A').replace(/\n/g, '<br>')}</div>
        </div>
        
        <div class="entry-section">
            <div class="entry-section-title">Action Taken</div>
            <div>${(entry['Action taken'] || 'N/A').replace(/\n/g, '<br>')}</div>
        </div>
        
        ${entry['Maintenance Name'] || entry.DateDone || entry.TimeDone || entry['Further action details'] ? `
        <div class="entry-section">
            <div class="entry-section-title">Maintenance Completion</div>
            <div class="entry-row">
                <span class="entry-label">Maintenance Name:</span>
                <span class="entry-value">${entry['Maintenance Name'] || 'N/A'}</span>
            </div>
            ${dateDone ? `
            <div class="entry-row">
                <span class="entry-label">Date Done:</span>
                <span class="entry-value">${dateDone}</span>
            </div>
            ` : ''}
            ${timeDone ? `
            <div class="entry-row">
                <span class="entry-label">Time Done:</span>
                <span class="entry-value">${timeDone}</span>
            </div>
            ` : ''}
            ${entry['Further action details'] ? `
            <div style="margin-top: 10px;">
                <div class="entry-section-title">Further Action Details</div>
                <div>${(entry['Further action details'] || '').replace(/\n/g, '<br>')}</div>
            </div>
            ` : ''}
        </div>
        ` : ''}
    </div>
`;
            });

            printHTML += `
    <div class="footer">
        Total Entries: ${selectedEntries.length}
    </div>
</body>
</html>
`;

            printWindow.document.write(printHTML);
            printWindow.document.close();
            
            // Wait for content to load, then print
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }

        // Event listeners
        document.getElementById('saveButton').addEventListener('click', saveEntry);
        document.getElementById('newButton').addEventListener('click', newEntry);
        document.getElementById('searchButton').addEventListener('click', searchEntries);
        document.getElementById('clearSearchButton').addEventListener('click', clearSearch);

        // Initialize form on page load
        if (entryId) {
            loadEntry(entryId);
        } else {
            // Clear form to ensure it starts empty
            newEntry();
            // Load entries for browse tab on initial load
            loadAllEntries();
        }

        // Load color scheme on page load
        loadColorScheme();
    </script>
</body>
</html>

